<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio Din√¢mico ‚Äì Wyckoff/Fibonacci (CoinMarketCap Style) - MOD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        :root {
            --bg-body: #f5f7fa;
            --bg-card: #ffffff;
            --bg-card-alt: #f7f9fc;
            --border-card: #e2e8f0;
            --border-soft: #e5ecf5;
            --text-main: #1e2733;
            --text-muted: #6b7280;
            --accent: #3861fb;
            --accent-soft: rgba(56, 97, 251, 0.08);
            --accent-strong: #1b44d1;
            --positive: #16a34a;
            --negative: #dc2626;
            --neutral: #f59e0b;
            --resistance: #dc2626; /* Vermelho para Resist√™ncia */
            --support: #16a34a; /* Verde para Suporte */

            --score-high: #16a34a;
            --score-mid: #f97316;
            --score-low: #dc2626;

            --shadow-soft: 0 10px 30px rgba(15,23,42,0.08);
        }

        * {
            box-sizing: border-box;
            font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            padding: 10px;
        }

        h1 {
            margin: 8px 0 4px;
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            color: var(--text-main);
        }

        .subtitle {
            text-align: center;
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .disclaimer {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 10px;
            font-size: 0.78rem;
            color: var(--text-muted);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-soft);
            margin-bottom: 10px;
        }

        .disclaimer strong {
            color: var(--text-main);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .top-bar button {
            border: none;
            border-radius: 999px;
            padding: 6px 12px;
            background: var(--accent);
            color: #ffffff;
            font-weight: 600;
            font-size: 0.78rem;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(56,97,251,0.25);
        }

        .top-bar button.secondary {
            background: #ffffff;
            color: var(--text-main);
            border: 1px solid var(--border-card);
            box-shadow: none;
        }

        .top-bar button:active {
            transform: translateY(1px);
        }

        #auto-refresh-status {
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .countdown-display {
            font-weight: 600;
            color: var(--accent-strong);
        }

        .search-input {
            width: 100%;
            padding: 7px 12px;
            border-radius: 999px;
            border: 1px solid var(--border-card);
            background: #ffffff;
            color: var(--text-main);
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(56,97,251,0.25);
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }

        .filter-group label {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid var(--border-card);
            background: var(--bg-card);
            color: var(--text-muted);
        }

        .filter-group input[type="radio"] {
            accent-color: var(--accent);
        }

        .filter-group label.active {
            border-color: var(--accent);
            background: var(--accent-soft);
            color: var(--accent-strong);
            font-weight: 600;
        }

        #card-container {
            margin-top: 6px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-card);
            margin-bottom: 10px;
            padding: 10px;
            box-shadow: var(--shadow-soft);
            position: relative;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .card-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ticker {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .token-name {
            font-size: 0.73rem;
            color: var(--text-muted);
        }
        
        .token-info-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .token-rank {
            font-size: 0.7rem;
            padding: 1px 6px;
            border-radius: 4px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border-soft);
            color: var(--text-muted);
        }

        .badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: var(--accent-soft);
            border: 1px solid rgba(56,97,251,0.3);
            color: var(--accent-strong);
            white-space: nowrap;
        }

        .price {
            font-size: 0.95rem;
            font-weight: 600;
            text-align: right;
            cursor: pointer;
        }

        .price-change {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 999px;
            text-align: right;
            display: inline-block;
            margin-top: 2px;
            cursor: pointer;
        }

        .positive {
            color: var(--positive);
        }

        .negative {
            color: var(--negative);
        }

        .neutral {
            color: var(--neutral);
        }

        .price-change.positive {
            background: rgba(22,163,74,0.08);
        }

        .price-change.negative {
            background: rgba(220,38,38,0.08);
        }

        .price-change.neutral {
            background: rgba(245,158,11,0.08);
        }

        .card-main-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 6px;
            gap: 8px;
        }

        .main-metrics {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.78rem;
            width: 60%;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            gap: 6px;
        }

        .metric-row.metric-clickable {
            cursor: pointer;
        }

        .metric-label {
            color: var(--text-muted);
            cursor: pointer;
        }

        .metric-value {
            font-weight: 500;
            text-align: right;
            cursor: pointer;
        }

        .rsi-high { color: var(--negative); font-weight: 600; }
        .rsi-low { color: var(--positive); font-weight: 600; }
        
        .sr-support { color: var(--support); font-weight: 600; }
        .sr-resistance { color: var(--resistance); font-weight: 600; }

        .score-badge {
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #ffffff;
        }
        .score-high { background: var(--score-high); }
        .score-mid  { background: var(--score-mid); }
        .score-low  { background: var(--score-low); }

        .sparkline-wrapper {
            width: 40%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas.sparkline {
            width: 100%;
            height: 40px;
        }

        .card-toggle {
            font-size: 0.72rem;
            color: var(--accent-strong);
            cursor: pointer;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px dashed var(--border-soft);
            text-align: center;
        }

        .card-details {
            margin-top: 8px;
            display: none;
        }

        .card.expanded .card-details {
            display: block;
        }

        .detail-grid {
            /* 3 colunas para acomodar a maior quantidade de m√©tricas individuais */
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr)); 
            gap: 6px;
            font-size: 0.75rem;
        }
        
        .detail-group-separator {
            grid-column: 1 / span 3; /* Ocupa 3 colunas */
            font-size: 0.7rem;
            color: var(--accent-strong);
            font-weight: 600;
            margin-top: 4px;
            margin-bottom: 2px;
            border-bottom: 1px solid var(--border-soft);
            padding-bottom: 2px;
        }

        .detail-item {
            padding: 6px;
            border-radius: 8px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border-soft);
        }

        .detail-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 2px;
            cursor: pointer;
        }

        .detail-value {
            font-weight: 500;
            cursor: pointer;
        }

        .detail-hint {
            font-size: 0.68rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .wyckoff-tag {
            margin-top: 8px;
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .wyckoff-tag strong {
            color: var(--text-main);
        }

        .tradingview-container {
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-soft);
            background: #ffffff;
            height: 240px;
        }

        .ranking-dashboard {
            margin-top: 14px;
            padding: 10px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-soft);
            font-size: 0.75rem;
        }

        .ranking-dashboard h3 {
            margin: 0 0 4px;
            font-size: 0.85rem;
            color: var(--text-main);
        }

        .ranking-filters {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .ranking-columns {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
            margin-top: 4px;
        }

        .ranking-card {
            padding: 6px;
            border-radius: 8px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border-soft);
        }

        .ranking-card h4 {
            margin: 0 0 4px;
            font-size: 0.78rem;
            color: var(--text-main);
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            cursor: pointer;
        }

        .ranking-item span:last-child {
            font-weight: 600;
        }

        .alert-trade-section {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            background: var(--bg-card-alt);
            border: 1px dashed var(--border-soft);
        }

        .alert-trade-section h4 {
            margin: 0 0 6px;
            font-size: 0.8rem;
            color: var(--accent-strong);
        }

        .trade-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .trade-buttons button {
            flex-grow: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .trade-buttons button:active {
            transform: scale(0.98);
        }

        .trade-buttons .btn-buy {
            background-color: var(--positive);
            color: #ffffff;
        }

        .trade-buttons .btn-sell {
            background-color: var(--negative);
            color: #ffffff;
        }

        .trade-form input, .trade-form select {
            width: 100%;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-card);
            margin-bottom: 6px;
            font-size: 0.75rem;
        }

        .trade-form button {
            width: 100%;
            padding: 6px;
            border: none;
            border-radius: 6px;
            background: var(--accent);
            color: #ffffff;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .active-alerts-list, .trade-history-list {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 6px;
            padding-top: 4px;
            border-top: 1px dotted var(--border-soft);
        }

        .history-item, .alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px dotted rgba(107, 114, 128, 0.2);
        }

        .history-item:last-child, .alert-item:last-child {
            border-bottom: none;
        }

        .history-item span:first-child, .alert-item span:first-child {
            flex-grow: 1;
            font-weight: 500;
        }

        .history-item .val-positive { color: var(--positive); font-weight: 700; }
        .history-item .val-negative { color: var(--negative); font-weight: 700; }

        .remove-btn {
            background: transparent;
            border: none;
            color: var(--negative);
            font-size: 0.65rem;
            cursor: pointer;
            padding: 2px 4px;
            margin-left: 5px;
            opacity: 0.7;
        }
        .remove-btn:hover { opacity: 1; }

        #toast-container {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            max-width: 90%;
        }

        .toast {
            background-color: #111827;
            color: #f9fafb;
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 6px;
            box-shadow: 0 8px 24px rgba(15,23,42,0.4);
            border: 1px solid #1f2937;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            font-size: 0.75rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .metric-tooltip-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.35);
            display: none;
            align-items: flex-end;
            justify-content: center;
            z-index: 1100;
        }

        .metric-tooltip-overlay.active {
            display: flex;
        }

        .metric-tooltip-panel {
            width: 100%;
            max-width: 650px;
            background: #ffffff;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 -10px 30px rgba(15,23,42,0.3);
            padding: 10px 12px 12px;
            max-height: 55vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.18s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .metric-tooltip-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .metric-tooltip-title {
            font-size: 0.86rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .metric-tooltip-close {
            border: none;
            border-radius: 999px;
            padding: 5px 10px;
            background: var(--bg-card-alt);
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .metric-tooltip-body {
            font-size: 0.78rem;
            color: var(--text-main);
            overflow-y: auto;
            padding-right: 4px;
        }

        .metric-tooltip-body strong {
            color: var(--accent-strong);
        }

        /* Novo estilo para a dashboard de destaques */
        #dashboard-highlights {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-card);
            box-shadow: var(--shadow-soft);
        }

        #dashboard-highlights h3 {
            margin: 0 0 8px;
            font-size: 0.85rem;
            color: var(--text-main);
            border-bottom: 1px solid var(--border-soft);
            padding-bottom: 4px;
        }

        .highlight-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .highlight-card {
            font-size: 0.75rem;
            padding: 6px;
            border-radius: 8px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border-soft);
        }

        .highlight-card h4 {
            margin: 0 0 4px;
            font-size: 0.78rem;
            color: var(--accent-strong);
        }

        .highlight-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            cursor: pointer;
            position: relative;
        }

        .highlight-item span:last-child {
            font-weight: 600;
        }

        .highlight-item .positive { color: var(--positive); }
        .highlight-item .negative { color: var(--negative); }

        /* Estilos para os bot√µes de navega√ß√£o (Scroll) */
        .scroll-button-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .scroll-button {
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(56, 97, 251, 0.4);
            transition: background-color 0.2s;
        }

        .scroll-button:hover {
            background-color: var(--accent-strong);
        }

        /* NOVOS ESTILOS GEMINI */
        .gemini-analysis-section {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            background: var(--bg-card-alt);
            border: 1px dashed var(--accent-soft);
            text-align: center;
        }
        .gemini-analysis-section h4 {
            margin: 0 0 6px;
            font-size: 0.8rem;
            color: var(--accent-strong);
        }
        .analysis-result-box {
            margin-top: 8px;
            padding: 10px;
            background: #f1f6ff; /* light blue background */
            border-radius: 6px;
            border: 1px solid var(--accent-soft);
            text-align: left;
            font-size: 0.75rem;
            white-space: pre-wrap; /* Preserve formatting from Markdown */
        }
        .loading-indicator {
            display: none;
            font-size: 0.75rem;
            color: var(--accent);
            margin: 8px 0;
            font-weight: 600;
        }


        @media (min-width: 768px) {
            body {
                max-width: 650px;
                margin: 0 auto;
            }
            .highlight-grid {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body>
    <h1>Relat√≥rio Din√¢mico ‚Äì Wyckoff/Fibonacci</h1>
    <div class="subtitle">
        Leitura r√°pida em estilo CoinMarketCap, com foco em assimetria, contexto Wyckoff e refer√™ncias de Fibonacci.
    </div>

    <div class="disclaimer">
        <p style="margin:0 0 4px;">
            Este painel √© **exclusivamente educacional** e **n√£o √© uma corretora real**. Os registros de compra/venda s√£o **SIMULADOS** e armazenados localmente para estudo de **Wyckoff 2.0** e zonas de assimetria.
            N√£o constitui, em hip√≥tese alguma, recomenda√ß√£o de compra ou venda de ativos.
        </p>
        <p id="last-update" style="font-size:0.74rem; margin:0; color:var(--text-muted);">
            √öltima atualiza√ß√£o: carregando...
        </p>
    </div>

    <div class="top-bar">
        <div style="display:flex; gap:6px;">
            <button id="refresh-button">Atualizar agora</button>
        </div>
        <div id="auto-refresh-status">
            Atualiza√ß√£o autom√°tica em: <span id="countdown" class="countdown-display">--</span>
        </div>
    </div>

    <div id="dashboard-highlights">
        <h3>üèÜ Destaques de Mercado (Top 10 - 24h e Assimetria)</h3>
        <div class="highlight-grid" id="highlight-content">
            </div>
    </div>
    <input type="text" id="search-input" class="search-input"
           placeholder="Buscar por ticker ou nome (ex: BTC, Kaspa, Pendle)...">

    <div class="filter-group" id="wyckoff-filter-group">
        <label class="active">
            <input type="radio" name="wyckoff-filter" value="all" checked>
            Todas as fases
        </label>
        <label>
            <input type="radio" name="wyckoff-filter" value="acc">
            Fases de compra (Acum.)
        </label>
        <label>
            <input type="radio" name="wyckoff-filter" value="dist">
            Fases de venda (Dist.)
        </label>
        <label>
            <input type="radio" name="wyckoff-filter" value="neutro">
            Fases neutras/laterais
        </label>
    </div>

    <div id="card-container"></div>

    <div id="ranking-dashboard" class="ranking-dashboard">
        <h3>Dashboard de oportunidades (vis√£o geral)</h3>
        <div class="ranking-filters">
            Toque em qualquer linha do ranking para abrir o card correspondente e ver os detalhes Wyckoff/Fibonacci.
        </div>

        <div class="filter-group" id="dashboard-filter-group" style="margin-top:6px;">
            <label class="active">
                <input type="radio" name="dashboard-filter" value="geral" checked>
                Ranking geral
            </label>
            <label>
                <input type="radio" name="dashboard-filter" value="compra">
                Foco em compras
            </label>
            <label>
                <input type="radio" name="dashboard-filter" value="venda">
                Foco em vendas
            </label>
        </div>

        <div id="ranking-content"></div>
    </div>

    <div id="toast-container"></div>

    <!-- Bot√µes de Navega√ß√£o (Scroll) -->
    <div class="scroll-button-container">
        <button id="scroll-to-top" class="scroll-button" aria-label="Ir para o topo">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        </button>
        <button id="scroll-to-bottom" class="scroll-button" aria-label="Ir para o rodap√©">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        </button>
    </div>

    <div id="metric-tooltip-overlay" class="metric-tooltip-overlay">
        <div class="metric-tooltip-panel">
            <div class="metric-tooltip-header">
                <div id="metric-tooltip-title" class="metric-tooltip-title">M√©trica</div>
                <button id="metric-tooltip-close" class="metric-tooltip-close">Fechar</button>
            </div>
            <div id="metric-tooltip-body"></div>
        </div>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const CARD_CONTAINER = document.getElementById('card-container');
        const RANKING_CONTAINER = document.getElementById('ranking-content');
        const HIGHLIGHT_CONTAINER = document.getElementById('highlight-content');

        const API_BASE = 'https://api.coingecko.com/api/v3';
        const MARKETS_ENDPOINT = '/coins/markets';
        
        // Aumentado para 60s para reduzir a press√£o do limite de taxa da API
        const REFRESH_INTERVAL_MS = 60000;
        const MAX_RETRIES = 3;

        let allCryptoData = [];
        let btcPrice = null; // Armazena o pre√ßo do BTC
        let btc24hChange = null;
        let btc7dChange = null; // Armazena a varia√ß√£o de 7d do BTC
        let btc30dChange = null;
        let btc1yChange = null; // Armazena a varia√ß√£o de 1 ano do BTC
        
        let refreshTimer = null;
        let countdownTimer = null;
        let countdownSeconds = REFRESH_INTERVAL_MS / 1000;
        let activeAlerts = {};
        let tradeHistory = {};
        let currentWyckoffFilter = 'all';
        let currentDashboardFilter = 'geral';
        let currentSearchTerm = '';
        
        // --- CONFIGURA√á√ÉO DA API GEMINI ---
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const GEMINI_API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent`;
        const API_KEY = ""; // Ser√° preenchida pelo ambiente de execu√ß√£o

        // IDs dos Tokens (LINK adicionado e IDs revisados)
        const TOKENS_CONFIG = [
            // Tokens Originais
            { ticker: 'AAVE',   name: 'Aave',              id: 'aave' },
            { ticker: 'AERO',   name: 'Aerodrome Finance', id: 'aerodrome-finance' },
            { ticker: 'AR',     name: 'Arweave',           id: 'arweave' },
            { ticker: 'ARB',    name: 'Arbitrum',          id: 'arbitrum' },
            { ticker: 'ATH',    name: 'Aethir',            id: 'aethir' },
            { ticker: 'ATOM',   name: 'Cosmos Hub',        id: 'cosmos' },
            { ticker: 'AVAX',   name: 'Avalanche',         id: 'avalanche-2' },
            { ticker: 'BTC',    name: 'Bitcoin',           id: 'bitcoin' }, // BTC deve vir primeiro
            { ticker: 'CPOOL',  name: 'Clearpool',         id: 'clearpool' },
            { ticker: 'CFG',    name: 'Centrifuge',        id: 'centrifuge' },
            { ticker: 'DOT',    name: 'Polkadot',          id: 'polkadot' },
            { ticker: 'ETH',    name: 'Ethereum',          id: 'ethereum' },
            { ticker: 'ETHFI',  name: 'ether.fi',          id: 'ether-fi' },
            { ticker: 'EPIC',   name: 'Epic Chain',        id: 'epic-chain' },
            { ticker: 'GRIFFAIN', name: 'Griffain',        id: 'griffain' },
            { ticker: 'IMX',    name: 'Immutable',         id: 'immutable-x' },
            { ticker: 'IO',     name: 'io.net',            id: 'io-net' },
            { ticker: 'JUP',    name: 'Jupiter',           id: 'jupiter-exchange-solana' },
            { ticker: 'KAS',    name: 'Kaspa',             id: 'kaspa' },
            { ticker: 'LTC',    name: 'Litecoin',          id: 'litecoin' },
            { ticker: 'LDO',    name: 'Lido DAO',          id: 'lido-dao' },
            { ticker: 'METIS',  name: 'Metis',             id: 'metis-token' },
            { ticker: 'MORPHO', name: 'Morpho',            id: 'morpho' },
            { ticker: 'NEAR',   name: 'NEAR',              id: 'near' },
            { ticker: 'ONDO',   name: 'Ondo',              id: 'ondo-finance' },
            { ticker: 'PENDLE', name: 'Pendle',            id: 'pendle' },
            { ticker: 'POL',    name: 'Polygon',           id: 'polygon-ecosystem-token' },
            { ticker: 'PYTH',   name: 'Pyth Network',      id: 'pyth-network' },
            { ticker: 'QNT',    name: 'Quant',             id: 'quant-network' },
            { ticker: 'QUBIC',  name: 'Qubic',             id: 'qubic-network' },
            { ticker: 'RENDER', name: 'Render',            id: 'render-token' },
            { ticker: 'RIO',    name: 'Realio Network',    id: 'realio-network' },
            { ticker: 'RSR',    name: 'Reserve Rights',    id: 'reserve-rights-token' },
            { ticker: 'SEI',    name: 'Sei Network',       id: 'sei-network' },
            { ticker: 'SNX',    name: 'Synthetix',         id: 'synthetix-network-token' },
            { ticker: 'SPELL',  name: 'Spell',             id: 'spell-token' },
            { ticker: 'STX',    name: 'Stacks',            id: 'blockstack' },
            { ticker: 'SUI',    name: 'Sui',               id: 'sui' },
            { ticker: 'SYRUP',  name: 'Maple Finance',     id: 'maple' },
            { ticker: 'TAI',    name: 'Tars Protocol',     id: 'tars-protocol' },
            { ticker: 'TRU',    name: 'TrueFi',            id: 'truefi-token' },
            { ticker: 'VIRTUAL', name: 'Virtuals Protocol', id: 'virtual-protocol' },
            { ticker: 'VIRTUALS', name: 'Virtuals Protocol', id: 'virtual-protocol' },
            { ticker: 'ASTER',  name: 'Astar',             id: 'astar' },
            { ticker: 'XDC',    name: 'XDC Network',       id: 'xdce-crowd-sale' },
            { ticker: 'XTZ',    name: 'Tezos',             id: 'tezos' },

            // Novos Tokens Solicitados + LINK
            { ticker: 'LINK',   name: 'Chainlink',         id: 'chainlink' }, 
            { ticker: 'FET',    name: 'Artificial Superintelligence Alliance', id: 'fetch-ai' },
            { ticker: 'BNB',    name: 'BNB',               id: 'binancecoin' },
            { ticker: 'XMR',    name: 'Monero',            id: 'monero' },
            { ticker: 'XLM',    name: 'Stellar',           id: 'stellar' },
            { ticker: 'HBAR',   name: 'Hedera',            id: 'hedera-hashgraph' },
            { ticker: 'UNI',    name: 'Uniswap',           id: 'uniswap' },
            { ticker: 'MNT',    name: 'Mantle',            id: 'mantle' },
            { ticker: 'TAO',    name: 'Bittensor',         id: 'bittensor' },
            { ticker: 'ICP',    name: 'Internet Computer', id: 'internet-computer' },
            { ticker: 'FIL',    name: 'Filecoin',          id: 'filecoin' },
            { ticker: 'GRT',    name: 'The Graph',         id: 'the-graph' },
            { ticker: 'APT',    name: 'Aptos',             id: 'aptos' },
            { ticker: 'ENA',    name: 'Ethena',            id: 'ethena' },
            { ticker: 'ALGO',   name: 'Algorand',          id: 'algorand' },
            { ticker: 'PUMP',   name: 'Pump.fun',          id: 'pump-fun' }, 
            { ticker: 'DASH',   name: 'Dash',              id: 'dash' },
            { ticker: 'STRK',   name: 'Starknet',          id: 'starknet' },
            { ticker: 'TIA',    name: 'Celestia',          id: 'celestia' },
            { ticker: 'KSM',    name: 'Kusama',            id: 'kusama' },
            { ticker: 'INJ',    name: 'Injective',         id: 'injective-protocol' },
            { ticker: 'MYX',    name: 'MYX Finance',       id: 'myx-finance' }, 
            { ticker: 'SAND',   name: 'The Sandbox',       id: 'the-sandbox' },
            { ticker: 'HNT',    name: 'Helium',            id: 'helium' },
            { ticker: 'ZK',     name: 'ZKsync',            id: 'zksync' }, 
            { ticker: 'ZRO',    name: 'LayerZero',         id: 'layerzero' }, 
            { ticker: 'DIA',    name: 'Dia',               id: 'dia-data' },
            { ticker: 'KMNO',   name: 'Kamino',            id: 'kamino' }, 
            { ticker: 'AKT',    name: 'Akash Network',     id: 'akash-network' },
            { ticker: 'PLUME',  name: 'Plume',             id: 'plume' }, 
            { ticker: 'AVNT',   name: 'Avantis',           id: 'avantis' }, 
            { ticker: 'KTA',    name: 'Keeta',             id: 'keeta' }, 
            { ticker: 'COOKIE', name: 'Cookie DAO',        id: 'cookie' }
        ];

        // Contexto Wyckoff Est√°tico (Narrativas e descri√ß√µes aprimoradas)
        const STATIC_WYCKOFF_CONTEXT = {
            'BTC': 'Narrativa: **Layer 1 / Ouro Digital**. Contexto: O Bitcoin √© o ativo de reserva e define o tom do mercado. Sua fase atual √© de **Distribui√ß√£o Macro**, sugerindo que corre√ß√µes agressivas s√£o prov√°veis antes de novas m√°ximas. Acompanhe a for√ßa do d√≥lar.',
            'ETH': 'Narrativa: **Layer 1 / Smart Contracts**. Contexto: O Ethereum est√° em uma **Fase de Re-acumula√ß√£o (Fase B/C)**. A for√ßa das narrativas de Layer 2 e a transi√ß√£o para PoS suportam a tese de que grandes fundos continuam a absorver liquidez acima de suportes chave.',
            'KAS': 'Narrativa: **Layer 1 / PoW**. Contexto: Este ativo possui um forte momentum de Mark-up (Fase D/E). O comportamento agressivo de alta sugere exaust√£o pr√≥xima. **Risco:** Pullbacks s√£o violentos; a corre√ß√£o pode iniciar uma Distribui√ß√£o prolongada.',
            'IMX': 'Narrativa: **Layer 2 / Gaming**. Contexto: Forte candidato no setor de jogos. A estrutura atual indica uma **corre√ß√£o t√©cnica** em busca de zonas de demanda (Suporte). Isso se encaixa em uma Fase A/B de Acumula√ß√£o em um timeframe menor, buscando um ponto de partida.',
            'PENDLE': 'Narrativa: **DeFi / Yield**. Contexto: Ap√≥s um Mark-up explosivo, o PENDLE mostra sinais de **Distribui√ß√£o Institucional**. Se a perda de suportes cr√≠ticos for confirmada, o pre√ßo entrar√° em Redistribui√ß√£o ou Fase E de Distribui√ß√£o final.',
            'CFG': 'Narrativa: **RWA / DeFi**. Contexto: O ativo est√° em **Acumula√ß√£o de Fundo (Fase B/C)**. O baixo volume e a volatilidade contida sugerem que o Smart Money est√° posicionado e aguarda o catalisador. Riscos associados √† baixa liquidez.',
            'RIO': 'Narrativa: **RWA / Tokeniza√ß√£o**. Contexto: Estrutura em **Reacumula√ß√£o Especulativa**. Devido √† baixa liquidez e Market Cap, a a√ß√£o do pre√ßo √© mais vol√°til e menos previs√≠vel do que a Acumula√ß√£o Wyckoff Cl√°ssica.',
            'VIRTUAL': 'Narrativa: **Gaming / Metaverso**. Contexto: Ativo rec√©m-listado. Volatilidade extrema, alternando entre mini-fases de Distribui√ß√£o e Reacumula√ß√£o em curtos espa√ßos de tempo. N√£o √© recomendado para hold de longo prazo sem Stop Loss.',
            'GRIFFAIN': 'Narrativa: **Micro-Cap / Especulativo**. Contexto: Risco alt√≠ssimo. A assimetria extrema √© dependente de fluxo especulativo. As Fases Wyckoff (micro) s√£o sujeitas a manipula√ß√µes t√≠picas de micro-Wyckoff.',
            'LINK': 'Narrativa: **Or√°culos / Infraestrutura**. Contexto: Ativo de infraestrutura essencial. Est√° em um padr√£o claro de **Acumula√ß√£o/Reacumula√ß√£o** com fundos ascendentes. O mercado est√° absorvendo a oferta para um futuro rompimento (Mark-up).',
            'FET': 'Narrativa: **AI (Intelig√™ncia Artificial)**. Contexto: Uma das l√≠deres em AI. Sua estrutura √© de **Mark-up Estendido**. Procure sinais de exaust√£o (Distribui√ß√£o) ou use pullbacks para acumula√ß√£o em suportes relevantes.',
            'BNB': 'Narrativa: **Exchange / Layer 1**. Contexto: Ativo da Binance. Acompanha de perto o ciclo do BTC. Estrutura lateralizada que oscila entre Distribui√ß√£o e Reacumula√ß√£o de Topo. Risco de regula√ß√£o afeta o pre√ßo.',
            'XMR': 'Narrativa: **Privacidade / PoW**. Contexto: Ativo maduro, focado em privacidade. Sua longa **Acumula√ß√£o Lateral (Fase B)** sugere que uma grande movimenta√ß√£o (Mark-up) est√° sendo preparada (Causa -> Efeito).',
            'XLM': 'Narrativa: **Pagamentos / Layer 1**. Contexto: O ativo busca o fundo em um ciclo de **Acumula√ß√£o Prolongada**. O baixo volume e a lateralidade sugerem que a demanda √© fraca, necessitando de um evento de "Spring" (Fase C) para atrair liquidez.',
            'HBAR': 'Narrativa: **Governan√ßa / DLT**. Contexto: Forte foco institucional. Encontra-se nas **Fases Iniciais de Acumula√ß√£o**, onde o mercado est√° buscando liquidez. √â um bom ativo para DCA (Dollar-Cost Averaging) em zonas de demanda.',
            'UNI': 'Narrativa: **DeFi / DEX**. Contexto: Principal DEX do mercado. Est√° em **Mark-up (Fase D)**. Poss√≠vel Reacumula√ß√£o Intermedi√°ria. Enquanto mantiver suportes, a tend√™ncia √© de alta cont√≠nua.',
            'MNT': 'Narrativa: **Layer 2 / Ecossistema**. Contexto: Novo ativo de ecossistema. Estrutura de **Acumula√ß√£o** com potencial de rompimento ap√≥s absorver a oferta. Siga a liquidez do ecossistema.',
            'TAO': 'Narrativa: **AI / DePIN**. Contexto: Altamente especulativo devido √† narrativa de AI. Os ciclos Wyckoff s√£o **acelerados**. Requer an√°lise de volume em tempo real para identificar cl√≠max de compra/venda.',
            'ICP': 'Narrativa: **Cloud / Web3**. Contexto: Revers√£o recente de tend√™ncia. Est√° em **Reacumula√ß√£o**, testando os suportes para consolidar o movimento. Uma falha de suporte indica que a euforia inicial acabou.',
            'FIL': 'Narrativa: **Armazenamento / DePIN**. Contexto: Construindo um fundo ap√≥s uma forte tend√™ncia de baixa. Encontra-se na **Fase B/C de Acumula√ß√£o**, onde a volatilidade deve ser comprimida antes do Mark-up.',
            'GRT': 'Narrativa: **Infraestrutura / Indexa√ß√£o**. Contexto: Essencial para o ecossistema. Est√° em **Mark-up**, mas se aproximando de uma zona de Distribui√ß√£o/Resist√™ncia. Cuidado com o SOT (Shift of Trend) de topo.',
            'APT': 'Narrativa: **Layer 1**. Contexto: Ciclo de **Acumula√ß√£o** ativo. Est√° pr√≥ximo a uma regi√£o de valor (Suporte). Aguarde por um sinal de "Spring" (Fase C) para entradas de maior risco/recompensa.',
            'ENA': 'Narrativa: **Stablecoin Sint√©tica / DeFi**. Contexto: Ativo muito novo e vol√°til. A estrutura sugere **mini-Distribui√ß√£o** no curto prazo. Risco de liquida√ß√£o alto devido √† natureza sint√©tica.',
            'ALGO': 'Narrativa: **Layer 1**. Contexto: Longa **Acumula√ß√£o** com compress√£o de volatilidade (coiling). √â um sinal cl√°ssico de que um movimento forte est√° pr√≥ximo, seja para cima ou para baixo.',
            'PUMP': 'Narrativa: **Memecoin / Solana**. Contexto: Extrema volatilidade e risco. Use o micro-Wyckoff. As fases s√£o muito r√°pidas e dependem puramente da euforia da comunidade e do fluxo de capital.',
            'DASH': 'Narrativa: **Pagamentos / Privacidade**. Contexto: **Acumula√ß√£o de Fundo (Fase B)**. Possui baixa atra√ß√£o de volume no momento. A espera √© por um catalisador (Fase C).',
            'STRK': 'Narrativa: **Layer 2 / ZK Rollup**. Contexto: P√≥s-lan√ßamento. Est√° em **Acumula√ß√£o**, com o mercado definindo o valor justo. Testando a demanda em n√≠veis baixos, o que √© comum para novos L2s.',
            'TIA': 'Narrativa: **Modularidade**. Contexto: Ativo forte em **Mark-up**. Est√° em **Realiza√ß√£o (Pullback)**. A busca √© por uma zona de Reacumula√ß√£o intermedi√°ria para a pr√≥xima perna de alta.',
            'KSM': 'Narrativa: **Ecossistema Polkadot**. Contexto: **Acumula√ß√£o (Fase B)**. O mercado est√° quieto. √â o momento de buscar liquidez antes de um Mark-up. Sinal de longo prazo.',
            'INJ': 'Narrativa: **DeFi / Layer 1**. Contexto: Forte tend√™ncia. Em **Pullback/Realiza√ß√£o**. A procura √© por uma zona de Reacumula√ß√£o para continuar o ciclo Mark-up.',
            'MYX': 'Narrativa: **DEX / Perp√©tuos**. Contexto: Ativo novo. Fases iniciais de teste de mercado. **Volatilidade de descoberta de pre√ßo**. N√£o h√° um padr√£o Wyckoff claro ainda.',
            'SAND': 'Narrativa: **Metaverso / Gaming**. Contexto: **Acumula√ß√£o Ampla**. O mercado est√° no processo de absorver a oferta. Um rompimento da faixa lateral indicar√° o in√≠cio de um novo Mark-up.',
            'HNT': 'Narrativa: **DePIN / IoT**. Contexto: **Mark-up estendido**. Sinais de que o ciclo de alta est√° maduro, entrando em zonas de Distribui√ß√£o. Cuidado com picos de volume que n√£o resultam em fechamentos altos.',
            'ZK': 'Narrativa: **Layer 2 / ZK Rollup**. Contexto: Novo ativo. Estrutura de **Acumula√ß√£o P√≥s-Lan√ßamento**. O mercado est√° definindo a base para o futuro.',
            'ZRO': 'Narrativa: **Infraestrutura / Interoperabilidade**. Contexto: Novo ativo. Volatilidade, testes iniciais de Oferta e Demanda. A fase inicial de Acumula√ß√£o deve ser vol√°til.',
            'DIA': 'Narrativa: **Or√°culos / Dados**. Contexto: **Acumula√ß√£o de Fundo** com compress√£o de volatilidade. A base de pre√ßo est√° sendo constru√≠da. Aguarda-se o rompimento.',
            'KMNO': 'Narrativa: **DeFi / Lending**. Contexto: Ativo muito novo. **Testes iniciais de Demanda**. Risco alto at√© que um hist√≥rico de pre√ßos se estabele√ßa.',
            'AKT': 'Narrativa: **DePIN / Nuvem Descentralizada**. Contexto: **Mark-up forte**. Est√° buscando Resist√™ncias hist√≥ricas, indicando um poss√≠vel in√≠cio de Distribui√ß√£o. Mantenha cautela.',
            'PLUME': 'Narrativa: **RWA / Layer 2**. Contexto: Ativo novo. **Acumula√ß√£o** em andamento, com pouco hist√≥rico. Volatilidade esperada.',
            'AVNT': 'Narrativa: **Derivativos / Exchange**. Contexto: Ativo novo. Fases iniciais vol√°teis de **Teste de Oferta e Demanda**.',
            'KTA': 'Narrativa: **Gaming / Web3**. Contexto: Ativo novo. **Alta Volatilidade**. Aguarda-se a defini√ß√£o de um range de acumula√ß√£o.',
            'COOKIE': 'Narrativa: **Web3 / Marketing**. Contexto: Ativo novo. **Fases iniciais de Teste** de Mercado. Baixa liquidez e alta sensibilidade a fluxos de capital.'
        };

        // --- FUN√á√ïES DE C√ÅLCULO E FORMATA√á√ÉO ---

        function calculateRSIHeuristic(change24h, change7d) {
            if (isNaN(change24h) || isNaN(change7d)) {
                return { text: 'N/D', class: '', value: 50 };
            }
            let rsi = 50 + (change24h * 1.5) + (change7d * 0.2);
            rsi = Math.min(100, Math.max(0, rsi));
            let className = '';
            if (rsi >= 70) className = 'rsi-high';
            else if (rsi <= 30) className = 'rsi-low';
            return { text: rsi.toFixed(0), class: className, value: rsi };
        }

        // NOVO: C√°lculo Heur√≠stico de Suporte/Resist√™ncia (Ajustado)
        function calculateSRProximity(price, rangeLow, rangeHigh) {
            if (!price || !rangeLow || !rangeHigh || price === 0 || rangeLow === 0) return { text: 'N/D', class: 'neutral', value: 0 };
            
            const range = rangeHigh - rangeLow;
            if (range <= 0) return { text: 'Lateralizado', class: 'neutral', value: 0 };

            // Fator de proximidade: 40% √© a zona de interesse.
            const proximityFactor = 0.40; 

            const distToLow = price - rangeLow;
            const distToHigh = rangeHigh - price;

            // Classifica√ß√£o de Extremo
            if (price > rangeHigh) return { text: 'Cl√≠max/TOPO', class: 'sr-resistance', value: 1 };
            if (price < rangeLow) return { text: 'Cl√≠max/FUNDO', class: 'sr-support', value: 1 };


            if (distToLow / range < proximityFactor) {
                // Pre√ßo est√° na zona de 40% superior ao rangeLow
                return { text: 'Pr√≥x. Suporte', class: 'sr-support', value: (distToLow / range) };
            }
            if (distToHigh / range < proximityFactor) {
                // Pre√ßo est√° na zona de 40% inferior ao rangeHigh
                return { text: 'Pr√≥x. Resist.', class: 'sr-resistance', value: (distToHigh / range) };
            }

            return { text: 'Meio de Range', class: 'neutral', value: 0.5 }; // Valor ajustado para 0.5 para representar o meio
        }

        function determineWyckoffDynamic(change7d, change30d, marketCap, rsiValue) {
            if (isNaN(change7d) || isNaN(change30d) || isNaN(marketCap) || isNaN(rsiValue)) {
                return { text: 'Fase indefinida', class: '', phase: 'neutro' };
            }
            const marketCapThreshold = 500000000;
            const accThreshold = (marketCap < marketCapThreshold) ? 10 : 5;
            const distThreshold = (marketCap < marketCapThreshold) ? -10 : -5;

            if (rsiValue <= 35 && change30d < -20) {
                return { text: 'Fase C (Spring/Testes de fundo)', class: '', phase: 'acc' };
            }
            if (rsiValue >= 70 && change30d > 25) {
                return { text: 'Fase E (Cl√≠max/Distribui√ß√£o final)', class: '', phase: 'dist' };
            }
            if (change7d < distThreshold && change30d < -15) {
                return { text: 'Fase D/E (Distribui√ß√£o)', class: '', phase: 'dist' };
            }
            if (change7d > accThreshold && change30d > 10) {
                return { text: 'Fase D (Markup/Acumula√ß√£o tardia)', class: '', phase: 'acc' };
            }
            return { text: 'Fase B (Lateraliza√ß√£o/Neutro)', class: '', phase: 'neutro' };
        }

        function calculateSOTSignal(change1h, change24h, change7d) {
            if (isNaN(change1h) || isNaN(change24h) || isNaN(change7d)) {
                return { text: 'N/D', detail: 'Sem dados suficientes para avaliar a falha estrutural (SOT).' };
            }
            let signalText = 'Estrutura neutra';
            let detail = 'Sem indica√ß√£o clara de falha estrutural na continuidade de alta ou de baixa.';

            if (change7d > 10 && change24h < 0 && change1h < 0) {
                signalText = 'SOT de venda (falha de alta)';
                detail = 'Ap√≥s forte alta em 7 dias, o ativo perde for√ßa em 24h e 1h, sugerindo falha na continuidade da tend√™ncia de alta.';
            } else if (change7d < -10 && change24h > 0 && change1h > 0) {
                signalText = 'SOT de compra (falha de baixa)';
                detail = 'Ap√≥s forte queda em 7 dias, o ativo reage positivamente em 24h e 1h, sugerindo falha na continuidade da tend√™ncia de baixa.';
            } else if (change24h > 4 && change1h < 0) {
                signalText = 'Exaust√£o intradi√°ria de alta';
                detail = 'Movimento forte de alta em 24h, mas com fraqueza na √∫ltima hora, sugerindo exaust√£o local dos compradores.';
            } else if (change24h < -4 && change1h > 0) {
                signalText = 'Exaust√£o intradi√°ria de baixa';
                detail = 'Queda acentuada em 24h, acompanhada de recupera√ß√£o na √∫ltima hora, sugerindo entrada de demanda oportunista.';
            }
            return { text: signalText, detail };
        }

        function calculateERScore(change24h, change7d, marketCap) {
            if (isNaN(change24h) || isNaN(change7d) || isNaN(marketCap)) return 50;
            const momentumDeviation = change24h - (change7d / 7);
            let erScore = 50;

            if (Math.abs(momentumDeviation) > 5) erScore += 20;
            if (Math.abs(momentumDeviation) < 1 && Math.abs(change7d) > 5) erScore -= 10;
            if (Math.abs(change7d) > 10 && Math.abs(change24h) < 1) erScore = 20;

            return Math.min(100, Math.max(0, erScore));
        }

        function calculateAttractionScore(athDropPct, rsiValue, wyckoffPhase, erScore) {
            if (athDropPct === null || isNaN(rsiValue)) return null;
            let score = 0;

            if (athDropPct <= -70) score += 40;
            else if (athDropPct <= -50) score += 30;
            else if (athDropPct <= -30) score += 20;
            else if (athDropPct <= -15) score += 10;

            if (rsiValue <= 25) score += 30;
            else if (rsiValue <= 35) score += 20;
            else if (rsiValue <= 45) score += 10;
            else if (rsiValue <= 60) score += 5;

            if (wyckoffPhase === 'acc') score += 20;
            else if (wyckoffPhase === 'neutro') score += 5;
            else if (wyckoffPhase === 'dist') score -= 20;

            if (!isNaN(erScore)) {
                if (erScore <= 30) score += 10;
                else if (erScore >= 70) score -= 10;
            }

            return Math.min(100, Math.max(0, score));
        }

        // NOVO: Calcula a performance da Altcoin vs BTC para qualquer per√≠odo
        function calculateVsBtcPerformance(altChange, btcChange) {
            if (altChange === null || btcChange === null || isNaN(altChange) || isNaN(btcChange)) {
                return { text: 'N/D', class: 'neutral', value: 0 };
            }
            
            const diff = altChange - btcChange;
            const sign = diff > 0 ? '+' : '';
            const className = diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral';

            return { text: sign + diff.toFixed(2) + '%', class: className, value: diff };
        }

        function generateDynamicWyckoffSignal(item) {
            const change7d = item.price_change_percentage_7d_in_currency;
            const change30d = item.price_change_percentage_30d_in_currency;
            const marketCap = item.market_cap;

            const rsiHeuristic = calculateRSIHeuristic(
                item.price_change_percentage_24h_in_currency,
                change7d
            );
            const rsiValue = parseFloat(rsiHeuristic.text === 'N/D' ? '50' : rsiHeuristic.text);
            const wyckoffDynamic = determineWyckoffDynamic(change7d, change30d, marketCap, rsiValue);

            return {
                text: wyckoffDynamic.text,
                class: wyckoffDynamic.class,
                phase: wyckoffDynamic.phase,
                rsiHeuristic
            };
        }

        function calculateReversalAlert(item) {
            const c7d = item.price_change_percentage_7d_in_currency;
            const c30d = item.price_change_percentage_30d_in_currency;

            if (c7d === null || c30d === null || isNaN(c7d) || isNaN(c30d)) {
                return { text: 'Sem dados suficientes para revers√£o em 30 dias.' };
            }
            if (c30d < -35 && c7d > 5) {
                return { text: 'Revers√£o de alta em constru√ß√£o (short covering/short squeeze poss√≠vel).' };
            }
            if (c30d > 40 && c7d < -5) {
                return { text: 'Revers√£o de baixa ap√≥s cl√≠max de alta (distribui√ß√£o em andamento).' };
            }
            if (c30d < -20) {
                return { text: 'Press√£o vendedora dominante em 30 dias. Aten√ß√£o a sinais de exaust√£o para estudar compras.' };
            }
            if (c30d > 25) {
                return { text: 'Press√£o compradora dominante em 30 dias. Aten√ß√£o a sinais de distribui√ß√£o para estudar realiza√ß√µes.' };
            }
            return { text: 'Estrutura ainda neutra para revers√µes em 30 dias.' };
        }

        function calculateFibTargets(currentPrice) {
            if (!currentPrice || isNaN(currentPrice))
                return { buy: null, sell: null, stopLoss: null, causaEfeitoTP: null };

            const buy = currentPrice * (1 - 0.236);
            const sell = currentPrice * (1 + 0.382);
            const stopLoss = currentPrice * (1 - 0.05);
            const causaEfeitoTP = currentPrice * 1.5;
            return { buy, sell, stopLoss, causaEfeitoTP };
        }

        function estimateFutureRange(currentPrice, change7d, change30d) {
            if (!currentPrice || isNaN(currentPrice)) {
                return {
                    weekLow: null, weekHigh: null,
                    twoWeeksLow: null, twoWeeksHigh: null,
                    monthLow: null, monthHigh: null
                };
            }
            const vol7 = Math.abs(change7d || 0) / 100;
            const vol30 = Math.abs(change30d || 0) / 100;

            const weekLow = currentPrice * (1 - (vol7 || 0.08));
            const weekHigh = currentPrice * (1 + (vol7 || 0.08));

            const twoWeeksLow = currentPrice * (1 - (vol7 * 1.4 || 0.12));
            const twoWeeksHigh = currentPrice * (1 + (vol7 * 1.4 || 0.12));

            const monthLow = currentPrice * (1 - (vol30 || 0.18));
            const monthHigh = currentPrice * (1 + (vol30 || 0.18));

            return { weekLow, weekHigh, twoWeeksLow, twoWeeksHigh, monthLow, monthHigh };
        }

        function formatPrice(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/D';
            if (value >= 1) return '$ ' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (value >= 0.01) return '$ ' + value.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
            return '$ ' + value.toLocaleString('en-US', { minimumFractionDigits: 6, maximumFractionDigits: 6 });
        }

        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/D';
            const sign = value > 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        function formatDollarValue(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/D';
            if (value >= 1e9) return '$ ' + (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return '$ ' + (value / 1e6).toFixed(2) + 'M';
            return '$ ' + value.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }
        
        function formatTokenCount(value) {
            if (value === null || value === undefined || isNaN(value)) return 'N/D';
            if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            return value.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        // FUN√á√ÉO DE S√çMBOLO DO TRADINGVIEW ATUALIZADA
        function getTradingViewSymbol(ticker) {
            const baseTicker = ticker.toUpperCase();
            const preferredExchanges = {
                'BTC': 'BINANCE', 'ETH': 'BINANCE', 'KAS': 'MEXC', 'IMX': 'BINANCE', 'PENDLE': 'BINANCE',
                'SEI': 'BINANCE', 'SUI': 'BINANCE', 'STX': 'BINANCE', 'NEAR': 'BINANCE', 'RENDER': 'BINANCE',
                'ETHFI': 'BINANCE', 'VIRTUAL': 'GATEIO', 'TRU': 'BINANCE', 'CPOOL': 'KUCOIN', 'RIO': 'KUCOIN',
                'CFG': 'GATEIO', 'TAI': 'GATEIO', 'GRIFFAIN': 'MEXC', 'AAVE': 'BINANCE', 'ATOM': 'BINANCE',
                'AVAX': 'BINANCE', 'LTC': 'BINANCE', 'LDO': 'BINANCE', 'ONDO': 'BINANCE', 'PYTH': 'BINANCE',
                'SNX': 'BINANCE', 'QNT': 'BINANCE', 'RSR': 'BINANCE', 'QUBIC': 'MEXC', 'EPIC': 'MEXC',
                'POL': 'BINANCE', 'XDC': 'KUCOIN', 'METIS': 'BINANCE', 'IO': 'BINANCE', 'JUP': 'BINANCE',
                'MORPHO': 'BINANCE', 'ASTER': 'GATEIO', 'SYRUP': 'BINANCE', 'XTZ': 'BINANCE',
                // Novos tokens
                'LINK': 'BINANCE', 'FET': 'BINANCE', 'BNB': 'BINANCE', 'XMR': 'BINANCE', 'XLM': 'BINANCE', 'HBAR': 'BINANCE',
                'UNI': 'BINANCE', 'MNT': 'BINANCE', 'TAO': 'BINANCE', 'ICP': 'BINANCE', 'FIL': 'BINANCE',
                'GRT': 'BINANCE', 'APT': 'BINANCE', 'ENA': 'BINANCE', 'ALGO': 'BINANCE', 'PUMP': 'GATEIO',
                'DASH': 'BINANCE', 'STRK': 'BINANCE', 'TIA': 'BINANCE', 'KSM': 'BINANCE', 'INJ': 'BINANCE',
                'MYX': 'GATEIO', 'SAND': 'BINANCE', 'HNT': 'BINANCE', 'ZK': 'BINANCE', 'ZRO': 'BINANCE',
                'DIA': 'BINANCE', 'KMNO': 'BYBIT', 'AKT': 'KUCOIN', 'PLUME': 'GATEIO', 'AVNT': 'GATEIO',
                'KTA': 'MEXC', 'COOKIE': 'GATEIO'
            };
            const exchange = preferredExchanges[baseTicker] || 'BINANCE';
            return `${exchange}:${baseTicker}USDT`;
        }

        function showToast(message, duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 200);
            }, duration);
        }

        const tooltipOverlay = document.getElementById('metric-tooltip-overlay');
        const tooltipTitle = document.getElementById('metric-tooltip-title');
        const tooltipBody = document.getElementById('metric-tooltip-body');
        const tooltipCloseBtn = document.getElementById('metric-tooltip-close');

        function openMetricTooltip(title, bodyText) {
            tooltipTitle.textContent = title;
            tooltipBody.innerHTML = bodyText;
            tooltipOverlay.classList.add('active');
        }

        function closeMetricTooltip() {
            tooltipOverlay.classList.remove('active');
        }

        tooltipCloseBtn.addEventListener('click', closeMetricTooltip);
        tooltipOverlay.addEventListener('click', (e) => {
            if (e.target === tooltipOverlay) closeMetricTooltip();
        });

        // Fun√ß√£o de Atraso para Backoff
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // --- FUN√á√ïES DA API GEMINI LLM ---
        
        async function fetchGeminiContent(userQuery, systemPrompt, retries = 3) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Habilita o Grounding para buscar informa√ß√µes atualizadas na web
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(`${GEMINI_API_BASE_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (i < retries - 1) {
                            await sleep((2 ** i) * 1000); // Backoff: 1s, 2s, 4s
                            continue;
                        } else {
                            throw new Error(`Gemini API HTTP Error: ${response.statusText}`);
                        }
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources };
                    } else {
                        throw new Error("Gemini returned empty or malformed response.");
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Final Gemini fetch failure:", error);
                        return { text: `Desculpe, houve uma falha ao buscar a an√°lise fundamentalista (Erro: ${error.message}). Tente novamente mais tarde.`, sources: [] };
                    }
                }
            }
        }
        
        // NOVO: Fun√ß√£o para iniciar a an√°lise de sentimento por token
        window.fetchSentimentAnalysis = async function(ticker, narrative) {
            const container = document.getElementById(`gemini-result-${ticker}`);
            const loader = document.getElementById(`gemini-loader-${ticker}`);
            const button = document.getElementById(`gemini-btn-${ticker}`);

            container.innerHTML = '';
            loader.style.display = 'block';
            button.disabled = true;

            const userQuery = `Encontre as √∫ltimas not√≠cias (√∫ltimos 7 dias) sobre ${ticker} e, com base em sua narrativa de ${narrative}, determine o sentimento de mercado atual (Bullish, Bearish ou Neutro). Forne√ßa o resumo das not√≠cias e o sentimento em um par√°grafo conciso.`;
            const systemPrompt = `Voc√™ √© um analista fundamentalista de criptoativos de classe mundial. Sua resposta deve ser formatada em Markdown (pode usar listas, negrito e it√°lico), focando em an√°lise de sentimento e not√≠cias em tempo real. Comece com "An√°lise de Sentimento para ${ticker}:" e cite todas as suas fontes ao final.`;

            const result = await fetchGeminiContent(userQuery, systemPrompt);

            loader.style.display = 'none';
            button.disabled = false;
            
            let htmlContent = `<div class="analysis-result-box">`;
            
            // Renderiza o texto principal
            htmlContent += result.text.replace(/\n/g, '<br>'); // Converte quebras de linha para HTML
            
            if (result.sources.length > 0) {
                htmlContent += `<br><br><strong>Fontes Utilizadas:</strong>`;
                htmlContent += `<ul class="source-list" style="margin: 4px 0 0; padding-left: 15px; font-size: 0.65rem;">`;
                result.sources.forEach(source => {
                    htmlContent += `<li><a href="${source.uri}" target="_blank" style="color: var(--accent-strong); text-decoration: underline;">${source.title}</a></li>`;
                });
                htmlContent += `</ul>`;
            }
            htmlContent += `</div>`;

            container.innerHTML = htmlContent;
        };
        // FIM DAS FUN√á√ïES GEMINI
        // ---

        // --- FUN√á√ïES DE ARMAZENAMENTO E GEST√ÉO DE DADOS (Alertas e Trades) ---

        function loadDataFromStorage() {
            const storedAlerts = localStorage.getItem('wyckoff_alerts_v3');
            const storedTrades = localStorage.getItem('wyckoff_trades_v1');
            try {
                activeAlerts = storedAlerts ? JSON.parse(storedAlerts) : {};
                tradeHistory = storedTrades ? JSON.parse(storedTrades) : {};
            } catch {
                activeAlerts = {};
                tradeHistory = {};
            }
        }

        function saveAlertsToStorage() {
            localStorage.setItem('wyckoff_alerts_v3', JSON.stringify(activeAlerts));
        }

        function saveTradesToStorage() {
            localStorage.setItem('wyckoff_trades_v1', JSON.stringify(tradeHistory));
        }

        // Alerta
        function addAlert(ticker, type, price) {
            const id = Date.now().toString();
            if (!activeAlerts[ticker]) activeAlerts[ticker] = {};
            activeAlerts[ticker][id] = {
                id,
                ticker: ticker.toUpperCase(),
                type,
                price: parseFloat(price),
                triggered: false,
                date: new Date().toISOString()
            };
            saveAlertsToStorage();
            renderCardAlerts(ticker);
            showToast('Alerta salvo para ' + ticker.toUpperCase() + '.', 2200);
        }

        function removeAlert(ticker, id) {
            if (activeAlerts[ticker] && activeAlerts[ticker][id]) {
                delete activeAlerts[ticker][id];
                if (Object.keys(activeAlerts[ticker]).length === 0) {
                    delete activeAlerts[ticker];
                }
                saveAlertsToStorage();
                renderCardAlerts(ticker);
                showToast('Alerta removido para ' + ticker.toUpperCase() + '.', 2200);
            }
        }

        function checkAlerts(data) {
            data.forEach(item => {
                const ticker = item.ticker;
                const price = item.current_price;

                if (activeAlerts[ticker]) {
                    Object.keys(activeAlerts[ticker]).forEach(id => {
                        const alert = activeAlerts[ticker][id];
                        if (!alert || alert.triggered) return;

                        if (alert.type === 'buy' && price <= alert.price) {
                            alert.triggered = true;
                            showToast(`üîî Alerta de COMPRA: ${alert.ticker} tocou ${formatPrice(price)} (‚â§ ${formatPrice(alert.price)})`, 5000);
                        } else if (alert.type === 'sell' && price >= alert.price) {
                            alert.triggered = true;
                            showToast(`üîî Alerta de VENDA: ${alert.ticker} tocou ${formatPrice(price)} (‚â• ${formatPrice(alert.price)})`, 5000);
                        }
                    });
                }
            });

            saveAlertsToStorage();
        }

        // Hist√≥rico de Trades (Simula√ß√£o)
        function registerTrade(ticker, type, price, currentPrice) {
            const id = Date.now().toString();
            if (!tradeHistory[ticker]) tradeHistory[ticker] = [];

            let profitLossPct = 0;
            let profitLossPrice = 0;
            let transactionType = type.toUpperCase();

            // L√≥gica de fechamento de trade (venda)
            if (type === 'sell' && tradeHistory[ticker].length > 0) {
                const lastBuyIndex = tradeHistory[ticker].findIndex(t => t.type === 'BUY' && !t.closed);
                if (lastBuyIndex !== -1) {
                    const buyTrade = tradeHistory[ticker][lastBuyIndex];
                    profitLossPct = ((price - buyTrade.price) / buyTrade.price) * 100;
                    profitLossPrice = price - buyTrade.price;
                    buyTrade.closed = true;
                    buyTrade.sellPrice = price;
                    buyTrade.sellDate = new Date().toISOString();
                    buyTrade.profitLossPct = profitLossPct;
                    buyTrade.profitLossPrice = profitLossPrice;
                    buyTrade.transactionType = 'CLOSE_SELL';
                    saveTradesToStorage();
                    renderCardTrades(ticker);
                    const action = profitLossPct >= 0 ? 'Lucro' : 'Preju√≠zo';
                    showToast(`‚úÖ ${action} de ${formatPercent(profitLossPct)} registrado para ${ticker}`, 4000);
                    return;
                }
            }

            // Registro de nova compra ou venda (abertura de posi√ß√£o)
            tradeHistory[ticker].push({
                id,
                ticker: ticker.toUpperCase(),
                type: transactionType === 'SELL' ? 'OPEN_SELL' : 'BUY',
                price: parseFloat(price),
                date: new Date().toISOString(),
                currentPrice: currentPrice,
                closed: false
            });

            saveTradesToStorage();
            renderCardTrades(ticker);
            showToast(`${type === 'buy' ? 'Compra' : 'Venda (short)'} simulada registrada para ${ticker}`, 3000);
        }


        function renderCardAlerts(ticker) {
            const container = document.querySelector(`.card[data-ticker="${ticker}"] .active-alerts-list`);
            if (!container) return;

            const alerts = activeAlerts[ticker] ? Object.values(activeAlerts[ticker]) : [];
            if (alerts.length === 0) {
                container.innerHTML = '<p style="margin:0; font-size:0.7rem;">Nenhum alerta de pre√ßo ativo.</p>';
                return;
            }

            let html = '<p style="margin:0 0 4px; font-weight:600; color:var(--text-main);">Alertas ativos:</p>';
            alerts.forEach(a => {
                html += `
                    <div class="alert-item">
                        <span>
                            ${a.type === 'buy' ? 'COMPRA' : 'VENDA'} @ ${formatPrice(a.price)}
                            ${a.triggered ? '<span style="color:#f59e0b;font-weight:600;"> (ATINGIDO)</span>' : ''}
                        </span>
                        <button class="remove-btn" onclick="(function(){ removeAlert('${ticker}', '${a.id}'); })()">remover</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderCardTrades(ticker) {
            const container = document.querySelector(`.card[data-ticker="${ticker}"] .trade-history-list`);
            const itemData = allCryptoData.find(c => c.ticker === ticker);
            const currentPrice = itemData ? itemData.current_price : null;

            if (!container) return;

            const trades = tradeHistory[ticker] || [];
            if (trades.length === 0) {
                container.innerHTML = '<p style="margin:0; font-size:0.7rem;">Nenhum hist√≥rico de trade simulado.</p>';
                return;
            }

            let html = '<p style="margin:0 0 4px; font-weight:600; color:var(--text-main);">Hist√≥rico de trades (Simula√ß√£o):</p>';
            trades.reverse().forEach(t => { // Mostrar mais recente primeiro
                let pnlDisplay = '';
                let statusClass = '';

                if (t.closed) {
                    statusClass = t.profitLossPct >= 0 ? 'val-positive' : 'val-negative';
                    pnlDisplay = `<span class="${statusClass}"> (${formatPercent(t.profitLossPct)})</span>`;
                    html += `
                        <div class="history-item">
                            <span>
                                ${t.type === 'BUY' ? 'COMPRA' : t.type} @ ${formatPrice(t.price)}
                                <br>FECHOU @ ${formatPrice(t.sellPrice)}
                            </span>
                            ${pnlDisplay}
                        </div>
                    `;
                } else {
                    // Posi√ß√£o em aberto
                    if (t.type === 'BUY' && currentPrice) {
                        const currentPnlPct = ((currentPrice - t.price) / t.price) * 100;
                        statusClass = currentPnlPct >= 0 ? 'val-positive' : 'val-negative';
                        pnlDisplay = `<span class="${statusClass}"> (${formatPercent(currentPnlPct)})`;
                    }
                    html += `
                        <div class="history-item">
                            <span>${t.type} @ ${formatPrice(t.price)} (em aberto)</span>
                            ${pnlDisplay}
                        </div>
                    `;
                }
            });
            container.innerHTML = html;
        }


        // --- FUN√á√ïES DE INTERPRETA√á√ÉO E TOOLTIP (M√ÅXIMA DID√ÅTICA) ---

        function getAnalyticalInterpretation(label, value, item, isValue) {
            const ticker = item.ticker;
            
            // Defini√ß√µes de an√°lise baseadas no valor para o lado direito (isValue = true)
            if (isValue) {
                switch (label) {
                    case 'Pre√ßo atual':
                        return `**An√°lise de Mercado (Pre√ßo):** O pre√ßo de negocia√ß√£o mais recente √© **${formatPrice(item.current_price)}**. Este √© o pre√ßo que o mercado atribui ao ativo neste exato momento e serve como ponto de partida para toda a sua an√°lise de risco e alvo.`;
                    case 'Varia√ß√£o 1h':
                        const c1h = item.price_change_percentage_1h_in_currency;
                        return `**An√°lise de Momentum Imediato (1h):** O ativo variou ${formatPercent(c1h)}. Varia√ß√µes abruptas (acima de 2%) podem sinalizar **exaust√£o (cl√≠max)** ou entrada s√∫bita de baleias. Use esta m√©trica para timing de entrada/sa√≠da em prazos muito curtos.`;
                    case 'Varia√ß√£o 24h':
                        const c24h = item.price_change_percentage_24h_in_currency;
                        return `**An√°lise de Momentum Di√°rio (24h):** O ativo variou ${formatPercent(c24h)}. Varia√ß√µes fortes (acima de 5%) indicam **forte demanda** (se positivo) ou **p√¢nico** (se negativo). √â um indicador chave de euforia ou medo.`;
                    case 'Varia√ß√£o 7D':
                        const c7d = item.price_change_percentage_7d_in_currency;
                        return `**An√°lise de Curto Prazo (7D):** O ativo variou ${formatPercent(c7d)}. Se este valor for **positivo**, a tend√™ncia de curto prazo √© de alta. Se for **negativo**, indica um pullback ou corre√ß√£o. √â crucial para identificar a dire√ß√£o semanal do pre√ßo.`;
                    case 'Varia√ß√£o 30D':
                        const c30d = item.price_change_percentage_30d_in_currency;
                        return `**An√°lise de M√©dio Prazo (30D):** O ativo variou ${formatPercent(c30d)}. Se o valor for **muito positivo** (>20%), indica um Mark-up (Fase E) saud√°vel, mas tamb√©m risco de Distribui√ß√£o. Se for **muito negativo** (<-20%), indica Acumula√ß√£o ou bear market.`;
                    case 'Varia√ß√£o 1 Ano':
                        const c1y = item.price_change_percentage_1y_in_currency;
                        if (c1y === null || isNaN(c1y)) return `**An√°lise de Longo Prazo:** N√£o h√° dados suficientes (1 ano) para avaliar o ciclo macro do ativo. **DECIS√ÉO: Risco Aumentado**, pois a tend√™ncia estrutural n√£o pode ser verificada.`;
                        return `**An√°lise de Longo Prazo (1 Ano):** O ativo variou ${formatPercent(c1y)} no √∫ltimo ano. **Um valor POSITIVO e ALTO** (>100%) confirma um forte ciclo de alta e uma narrativa poderosa. **Um valor NEGATIVO** sugere que o ativo ainda n√£o saiu da Fase de Acumula√ß√£o/Fundo.`;

                    // ALPHAS VS BTC
                    case 'Alpha vs. BTC (24H)':
                    case 'Alpha vs. BTC (7D)':
                    case 'Alpha vs. BTC (30D)':
                    case 'Alpha vs. BTC (1 Ano)':
                        let period = label.match(/\((.*?)\)/)[1];
                        let alphaAnalysis;
                        if (value > 0.5) {
                            alphaAnalysis = `O ativo **superou o Bitcoin** em ${formatPercent(value)} neste per√≠odo. **CONCLUS√ÉO: For√ßa Relativa (ALPHA)**. O capital est√° migrando do BTC para este ativo, o que √© um sinal de grande potencial para Altcoins.`;
                        } else if (value < -0.5) {
                            alphaAnalysis = `O ativo **perdeu valor contra o Bitcoin** em ${formatPercent(value)} neste per√≠odo. **CONCLUS√ÉO: Fraqueza Relativa (BETA)**. Indica que a press√£o vendedora neste ativo √© maior que a do mercado geral.`;
                        } else {
                            alphaAnalysis = `O desempenho est√° em linha com o Bitcoin. **CONCLUS√ÉO: Neutro**. Acompanha o mercado, sem destaque.`;
                        }
                        return `**Valor Analisado (${period}): ${formatPercent(value)}**. ${alphaAnalysis} Esta √© a m√©trica mais importante para medir a for√ßa estrutural de uma Altcoin.`;

                    case 'Proximidade S/R (Heur√≠stica)':
                        const srText = item.sr_proximity.text;
                        const srClass = item.sr_proximity.class;
                        
                        if (srClass === 'sr-support') {
                            return `**An√°lise T√©cnica:** O pre√ßo est√° a **40% de dist√¢ncia** do Suporte projetado. **DECIS√ÉO: Oportunidade de Compra/Entrada**. Esta √© a melhor zona para acumular, pois o risco (stop) √© pr√≥ximo e a potencial recompensa √© alta.`;
                        } else if (srClass === 'sr-resistance') {
                            return `**An√°lise T√©cnica:** O pre√ßo est√° a **40% de dist√¢ncia** da Resist√™ncia projetada. **DECIS√ÉO: Risco/Realiza√ß√£o de Lucros**. Zona de alta oferta. Considere **reduzir o risco** ou abrir posi√ß√µes vendidas (short).`;
                        }
                        return `**An√°lise T√©cnica:** O pre√ßo est√° no **Meio do Range**. **DECIS√ÉO: Neutro/Aguardar**. O risco/recompensa n√£o √© favor√°vel. Espere o pre√ßo se aproximar de um Suporte ou Resist√™ncia.`;

                    // ZONAS & RISCO
                    case 'Pre√ßo-alvo de compra (Fibonacci)':
                        return `**An√°lise (Ponto de Entrada Sugerido):** Pre√ßo de **${formatPrice(value)}**. Este n√≠vel (23.6% de retra√ß√£o) √© o **desconto m√≠nimo** para considerar uma entrada t√©cnica. Se o pre√ßo cair at√© aqui, h√° uma alta probabilidade de rea√ß√£o dos compradores.`;
                    case 'Pre√ßo-alvo de realiza√ß√£o (Fibonacci)':
                        return `**An√°lise (Ponto de Sa√≠da Parcial):** Pre√ßo de **${formatPrice(value)}**. Se atingido (38.2% de expans√£o), indica que o trade est√° em lucro. **DECIS√ÉO: Realize parte do lucro** e mova o stop para o ponto de entrada (breakeven) para garantir um trade sem risco.`;
                    case 'Stop t√©cnico de prote√ß√£o (Fibonacci)':
                        return `**An√°lise (Invalida√ß√£o de Tese):** Pre√ßo de **${formatPrice(value)}**. **DECIS√ÉO: SA√çDA IMEDIATA**. Se o pre√ßo fechar abaixo deste valor (5% de perda), sua tese de alta foi refutada. Sair √© crucial para limitar perdas.`;
                    case 'Alvo de causa x efeito (Wyckoff + Fib)':
                        return `**An√°lise (Potencial M√°ximo):** Pre√ßo de **${formatPrice(value)}**. Representa o potencial de valoriza√ß√£o m√°xima (Mark-up - Fase E) baseado na energia acumulada (Causa). √â um alvo para investidores de **longu√≠ssimo prazo**.`;
                    case 'Desconto atual em rela√ß√£o ao topo hist√≥rico (ATH)':
                        const pct = value ? value.toFixed(2) : 'N/D';
                        let descText;
                        if (value === null || value > -10) { descText = "O ativo est√° muito pr√≥ximo do ATH. **Risco de entrada ALTO**, pois o potencial de queda √© maior do que o potencial de valoriza√ß√£o."; }
                        else if (value <= -70) { descText = `O desconto de ${pct}% √© **PROFUNDO**. Sugere a **M√ÅXIMA MARGEM DE SEGURAN√áA** para acumula√ß√£o de longo prazo.`; }
                        else if (value <= -30) { descText = `O desconto de ${pct}% √© **MODERADO**. Oferece uma boa janela de oportunidade para acumula√ß√£o.`; }
                        else { descText = `O desconto de ${pct}% √© **BAIXO**.`; }
                        return `**Valor Analisado: ${pct}%**. ${descText}`;

                    // FUNDAMENTOS E TOKEN√îMICA
                    case 'Fully Diluted Valuation (FDV) (Risco de Dilui√ß√£o)':
                        const fdvVal = item.fully_diluted_valuation;
                        const mcVal = item.market_cap;
                        if (mcVal === null || fdvVal === null || fdvVal === 0 || isNaN(fdvVal)) {
                            return '**An√°lise:** FDV indispon√≠vel. **RISCO**: Sem dados, a dilui√ß√£o futura n√£o pode ser avaliada. Cautela m√°xima.';
                        }
                        const dilutionPct = (fdvVal - mcVal) / mcVal;
                        let dilutionText;
                        if (dilutionPct > 5) { // 500%
                            dilutionText = `FDV (${formatDollarValue(fdvVal)}) √© **MUITO MAIOR** que o MCap. **RISCO EXTREMO**. Futuros desbloqueios de tokens podem pressionar o pre√ßo drasticamente. Evite ou invista apenas em tokens j√° em circula√ß√£o.`;
                        } else if (dilutionPct > 2) { 
                            dilutionText = `O risco de dilui√ß√£o √© **ALTO**. Avalie o cronograma de vesting (libera√ß√£o) dos tokens antes de investir.`;
                        } else if (dilutionPct > 0.5) { 
                            dilutionText = `O risco de dilui√ß√£o √© **MODERADO**.`;
                        } else {
                            dilutionText = `O risco de dilui√ß√£o √© **BAIXO**. Token√¥mica saud√°vel.`;
                        }
                        return `**Valor Analisado: ${formatDollarValue(fdvVal)}**. ${dilutionText}`;
                    case 'Tokens em Circula√ß√£o (Oferta Atual)':
                        const circSupply = item.circulating_supply;
                        const maxSupply = item.max_supply;
                        const circulatingRatio = maxSupply ? circSupply / maxSupply : null;
                        let supplyText;
                        if (circulatingRatio === null || maxSupply === null || isNaN(circSupply)) {
                            supplyText = `Tokens em Circula√ß√£o: ${formatTokenCount(circSupply)}. M√°x Supply indefinido.`;
                        } else if (circulatingRatio > 0.8) {
                            supplyText = `A maioria dos tokens (aprox. ${(circulatingRatio * 100).toFixed(0)}%) j√° est√° em circula√ß√£o. **MUITO FAVOR√ÅVEL**, pois o pre√ßo n√£o ser√° t√£o afetado por futuras libera√ß√µes.`;
                        } else if (circulatingRatio < 0.5) {
                            supplyText = `Menos da metade dos tokens est√° em circula√ß√£o. **ATEN√á√ÉO:** Grande volume pode ser liberado futuramente (dilui√ß√£o).`;
                        } else {
                            supplyText = `A oferta circulante √© **MODERADA**.`;
                        }
                        return `**Valor Analisado:** ${formatTokenCount(circSupply)} tokens em circula√ß√£o. ${supplyText}`;

                    // Indicadores de Momentum
                    case 'RSI heur√≠stico (for√ßa relativa aproximada)':
                        const rsi = item.rsi_heuristic.text;
                        let rsiAnalysis;
                        if (parseFloat(rsi) >= 70) { rsiAnalysis = `O RSI em **${rsi}** indica **SOBRE-COMPRA** (ativo caro). **DECIS√ÉO: Venda/Realize Lucros**. O risco de corre√ß√£o √© iminente.`; } 
                        else if (parseFloat(rsi) <= 30) { rsiAnalysis = `O RSI em **${rsi}** indica **SOBRE-VENDA** (ativo barato). **DECIS√ÉO: Procure entradas**. O ativo est√° tecnicamente descontado.`; } 
                        else { rsiAnalysis = `O RSI em **${rsi}** indica **NEUTRALIDADE**. A press√£o de compra/venda est√° equilibrada.`; }
                        return `**Valor Analisado: ${rsi}**. ${rsiAnalysis}`;
                    case 'Score de atra√ß√£o':
                        const score = item.attraction_score;
                        let scoreAnalysis;
                        if (score >= 70) { scoreAnalysis = `O Score **${score.toFixed(0)}** indica **ALTA ASSIMETRIA**. √â o momento ideal para considerar a acumula√ß√£o, pois o risco √© baixo e a recompensa √© alta.`; }
                        else if (score <= 40) { scoreAnalysis = `O Score **${score.toFixed(0)}** indica **BAIXA ASSIMETRIA**. **DECIS√ÉO: Evite Novas Entradas**. O ativo est√° supervalorizado.`; }
                        else { scoreAnalysis = `O Score **${score.toFixed(0)}** √© **MODERADO**. Siga outros indicadores.`; }
                        return `**Valor Analisado: ${scoreAnalysis}`;

                    // TUDO MAIS
                    case 'Sinal Wyckoff (din√¢mico)':
                        return `**Fase Ativa:** ${item.wyckoff_dynamic.text}. Esta √© a interpreta√ß√£o do est√°gio do ciclo. **DECIS√ÉO:** Use a fase para alinhar sua estrat√©gia: Acumula√ß√£o (Fases A, B, C) para **COMPRA/HOLD**, Distribui√ß√£o (Fases D, E) para **VENDA/SA√çDA**.`;
                    case 'Alerta de revers√£o em 30 dias':
                        return `**An√°lise de Revers√£o:** ${item.reversal_alert.text}. Alerta crucial para identificar a **exaust√£o do movimento** atual e a iminente mudan√ßa de dire√ß√£o.`;
                    case 'Leitura SOT / falha estrutural':
                        return `**An√°lise SOT:** ${item.sot_analysis.text}. O SOT (Shift of Trend) identifica que a tend√™ncia falhou em se sustentar, sinalizando uma **invers√£o de curto prazo**. √ötil para traders que buscam picos de volatilidade.`;
                    case 'Capitaliza√ß√£o de mercado (liquidez estrutural)':
                        return `**Valores Analisados:** MCap: ${formatDollarValue(item.market_cap)}, Volume 24h: ${formatDollarValue(item.total_volume)}. Ativos menores (Micro/Small Caps) t√™m mais volatilidade e potencial de alta, mas maior risco.`;
                    
                    // M√©tricas de Destaque
                    case 'Top Valorizadas (24h)':
                        return `**An√°lise (Valoriza√ß√£o):** ${formatPercent(value)}. Ativos neste ranking t√™m o maior risco de exaust√£o de curto prazo. **Aja com cautela ou realize lucros.**`;
                    case 'Top Desvalorizadas (24h)':
                        return `**An√°lise (Desvaloriza√ß√£o):** ${formatPercent(value)}. Ativos neste ranking t√™m o maior potencial de repique ou revers√£o de curto prazo em um suporte. **Procure por entradas agressivas.**`;
                    case 'Top Atra√ß√£o (Forte Compra)':
                        return `**An√°lise (Score):** ${value.toFixed(0)}. Estes s√£o os ativos que o sistema considera estarem nos pre√ßos mais descontados e seguros para acumula√ß√£o de longo prazo.`;
                    case 'Top Sobre-venda (Fraco)':
                        return `**An√°lise (RSI):** ${value.toFixed(0)}. Ativos com sobre-venda extrema geralmente atraem compradores oportunistas e podem iniciar um movimento de alta rapidamente.`;

                    // PROJE√á√ïES DE RANGE
                    case 'Faixa projetada para a pr√≥xima semana':
                    case 'Faixa projetada para 2 semanas':
                    case 'Faixa projetada para o pr√≥ximo m√™s':
                        const rangeLow = item.range_estimates.weekLow || item.range_estimates.twoWeeksLow || item.range_estimates.monthLow;
                        const rangeHigh = item.range_estimates.weekHigh || item.range_estimates.twoWeeksHigh || item.range_estimates.monthHigh;
                        return `**An√°lise da Amplitude:** A faixa projetada de ${formatPrice(rangeLow)} a ${formatPrice(rangeHigh)} √© a amplitude esperada do pre√ßo. A Faixa Alta funciona como **Resist√™ncia** e a Faixa Baixa como **Suporte**.`;

                    default:
                        return `**Interpreta√ß√£o Anal√≠tica do Valor:** N√£o h√° uma an√°lise espec√≠fica predefinida para este valor neste contexto.`;
                }
            }

            // Defini√ß√µes Conceituais para o lado esquerdo (Label)
            switch (label) {
                case 'Pre√ßo atual':
                    return 'Conceito: Pre√ßo de mercado atual. Serve como o ponto de refer√™ncia fundamental para todas as avalia√ß√µes de risco e alvo.';
                case 'Varia√ß√£o 1h':
                    return 'Conceito: **Momentum Imediato**. Varia√ß√£o percentual do pre√ßo na √∫ltima hora. Indicador de volatilidade extrema e fluxo de capital no curt√≠ssimo prazo.';
                case 'Varia√ß√£o 24h':
                    return 'Conceito: **Momentum Di√°rio**. Varia√ß√£o percentual do pre√ßo nas √∫ltimas 24 horas. Essencial para identificar o clima de mercado (euforia ou p√¢nico).';
                case 'Varia√ß√£o 7D':
                    return 'Conceito: **Tend√™ncia de Curto Prazo**. Varia√ß√£o percentual do pre√ßo nos √∫ltimos 7 dias. Define a dire√ß√£o dominante na semana.';
                case 'Varia√ß√£o 30D':
                    return 'Conceito: **Tend√™ncia de M√©dio Prazo**. Varia√ß√£o percentual do pre√ßo nos √∫ltimos 30 dias. Ajuda a identificar se o ativo est√° em Mark-up ou em Acumula√ß√£o/Corre√ß√£o.';
                case 'Varia√ß√£o 1 Ano':
                    return 'Conceito: **Tend√™ncia de Longo Prazo (Ciclo)**. Varia√ß√£o percentual do pre√ßo nos √∫ltimos 365 dias. Confirma a for√ßa da narrativa e a fase do ciclo macro.';
                
                // ALPHAS VS BTC
                case 'Alpha vs. BTC (24H)':
                    return 'Conceito: **Alpha Di√°rio**. Compara o desempenho do ativo com o Bitcoin nas √∫ltimas 24 horas. Positivo = Supera o BTC (Alpha), Negativo = Acompanha o BTC (Beta).';
                case 'Alpha vs. BTC (7D)':
                    return 'Conceito: **Alpha Semanal**. Compara o desempenho do ativo com o Bitcoin nos √∫ltimos 7 dias. Essencial para identificar o fluxo de capital para Altcoins.';
                case 'Alpha vs. BTC (30D)':
                    return 'Conceito: **Alpha Mensal**. Compara o desempenho do ativo com o Bitcoin nos √∫ltimos 30 dias. Indicador robusto da for√ßa estrutural do ativo no m√™s.';
                case 'Alpha vs. BTC (1 Ano)':
                    return 'Conceito: **Alpha Anual**. Compara o desempenho do ativo com o Bitcoin no √∫ltimo ano. Define se o ativo tem potencial para ser um ativo de investimento de longo prazo superior ao BTC.';

                case 'Proximidade S/R (Heur√≠stica)':
                    return 'Conceito: **Indicador de Zonas Cr√≠ticas**. Sinaliza se o pre√ßo est√° em uma zona de forte Suporte (demanda) ou Resist√™ncia (oferta). O fator de proximidade usado √© de 40% do range semanal.';
                case 'Pre√ßo-alvo de compra (Fibonacci)':
                    return 'Conceito: **Zona de Desconto**. N√≠vel de retra√ß√£o de 23.6% de Fibonacci. √â o primeiro alvo t√©cnico para procurar por entradas em um pullback saud√°vel.';
                case 'Pre√ßo-alvo de realiza√ß√£o (Fibonacci)':
                    return 'Conceito: **Alvo de Lucro Inicial**. N√≠vel de expans√£o de 38.2% de Fibonacci. Sugere o ponto ideal para a realiza√ß√£o parcial de lucros.';
                case 'Stop t√©cnico de prote√ß√£o (Fibonacci)':
                    return 'Conceito: **Gerenciamento de Risco**. O pre√ßo limite que, se violado, anula a tese de compra/trade, exigindo a sa√≠da para limitar a perda.';
                case 'Alvo de causa x efeito (Wyckoff + Fib)':
                    return 'Conceito: **Proje√ß√£o de Mark-up**. Combina o tamanho da acumula√ß√£o (Causa) para estimar o potencial m√°ximo de crescimento (Efeito) no longo prazo (Fase E).';
                case 'Desconto atual em rela√ß√£o ao topo hist√≥rico (ATH)':
                    return 'Conceito: **Margem de Seguran√ßa**. Indica o qu√£o descontado o ativo est√° em rela√ß√£o ao seu pico de pre√ßo (ATH). Quanto maior o desconto, maior o potencial de crescimento e menor o risco de entrada.';
                case 'Capitaliza√ß√£o de mercado (liquidez estrutural)':
                    return 'Conceito: **Tamanho e Volume**. MCap (valor total do ativo) e Volume (liquidez negociada). Ativos de menor MCap s√£o mais vol√°teis.';
                case 'Sinal Wyckoff (din√¢mico)':
                    return 'Conceito: **Ciclo de Mercado**. Classifica√ß√£o algor√≠tmica do est√°gio atual (Acumula√ß√£o, Distribui√ß√£o ou Mark-up) para definir a estrat√©gia macro.';
                case 'RSI heur√≠stico (for√ßa relativa aproximada)':
                    return 'Conceito: **Indicador de Exaust√£o**. Medida de momentum que sinaliza se o ativo est√° Sobre-Comprado (muito caro) ou Sobre-Vendido (muito barato).';
                case 'Alerta de revers√£o em 30 dias':
                    return 'Conceito: **Alerta de Invers√£o**. Sinaliza a exaust√£o da tend√™ncia dominante de m√©dio prazo (30 dias), sugerindo uma mudan√ßa iminente de dire√ß√£o.';
                case 'Leitura SOT / falha estrutural':
                    return 'Conceito: **Shift of Trend (SOT)**. Identifica quando a tend√™ncia atual falha em fazer um novo topo ou fundo, sinalizando uma quebra de estrutura e poss√≠vel invers√£o de curto prazo.';
                
                // Ranges
                case 'Faixa projetada para a pr√≥xima semana':
                    return 'Conceito: Estimativa da amplitude (m√≠nimo/m√°ximo) de pre√ßo esperada para os pr√≥ximos 7 dias, baseada na volatilidade hist√≥rica.';
                case 'Faixa projetada para 2 semanas':
                    return 'Conceito: Estimativa da amplitude (m√≠nimo/m√°ximo) de pre√ßo esperada para os pr√≥ximos 14 dias, √∫til para traders de swing.';
                case 'Faixa projetada para o pr√≥ximo m√™s':
                    return 'Conceito: Estimativa da amplitude (m√≠nimo/m√°ximo) de pre√ßo esperada para os pr√≥ximos 30 dias.';
                
                // Token√¥mica
                case 'Fully Diluted Valuation (FDV) (Risco de Dilui√ß√£o)':
                    return 'Conceito: **Risco de Dilui√ß√£o**. Valor do ativo se toda a oferta futura (incluindo tokens bloqueados) estivesse no mercado. Essencial para projetos novos; se for muito maior que o MCap, o risco de dilui√ß√£o √© alto.';
                case 'Tokens em Circula√ß√£o (Oferta Atual)':
                    return 'Conceito: **Oferta Imediata**. Quantidade de tokens j√° liberada e circulando no mercado. Uma oferta alta reduz o risco de desbloqueios futuros.';
                
                // Destaques
                case 'Top Valorizadas (24h)':
                    return 'Conceito: Ranking dos ativos com a maior valoriza√ß√£o nas √∫ltimas 24 horas. Indica alto momentum de curto prazo.';
                case 'Top Desvalorizadas (24h)':
                    return 'Conceito: Ranking dos ativos com a maior desvaloriza√ß√£o nas √∫ltimas 24 horas. Indica oportunidades de repique t√©cnico.';
                case 'Top Atra√ß√£o (Forte Compra)':
                    return 'Conceito: Ranking dos ativos com o melhor Score de Atra√ß√£o (Maior Assimetria Risco-Recompensa).';
                case 'Top Sobre-venda (Fraco)':
                    return 'Conceito: Ranking dos ativos com RSI heur√≠stico mais baixo (abaixo de 30), indicando sobre-venda extrema.';
                
                default:
                    return 'Conceito Anal√≠tico: Esta √© a descri√ß√£o conceitual da m√©trica.';
            }
        }
        
        function drawSparkline(canvas, data) {
            if (!canvas || !data || !data.length) return;
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const width = canvas.clientWidth * dpr;
            const height = canvas.clientHeight * dpr;

            canvas.width = width;
            canvas.height = height;

            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;

            ctx.clearRect(0, 0, width, height);
            ctx.lineWidth = 1.3 * dpr;
            ctx.strokeStyle = '#3861fb';
            ctx.beginPath();

            data.forEach((value, index) => {
                const x = (index / (data.length - 1)) * width;
                const y = height - ((value - min) / range) * height;
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.stroke();
        }

        // --- FUN√á√ïES PRINCIPAIS DE DADOS E RENDERIZA√á√ÉO (Com Backoff) ---

        async function fetchMarketData() {
            const ids = TOKENS_CONFIG.map(t => t.id).join(',');
            // Requisita todas as varia√ß√µes de pre√ßo, incluindo 1 ano.
            const url = `${API_BASE}${MARKETS_ENDPOINT}?vs_currency=usd&ids=${ids}&sparkline=true&price_change_percentage=1h,24h,7d,30d,1y`;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        if (i < MAX_RETRIES - 1) {
                            await sleep((2 ** i) * 1000); 
                            continue;
                        } else {
                            throw new Error('Erro ao buscar dados da API do CoinGecko.');
                        }
                    }

                    const data = await response.json();
                    
                    // 1. Encontra os dados do BTC para c√°lculo de Alpha (Performance vs. BTC)
                    const btcItem = data.find(item => item.id === 'bitcoin');
                    btcPrice = btcItem ? btcItem.current_price : null;
                    
                    // CORRE√á√ÉO: Usar btcItem para extrair as varia√ß√µes
                    btc24hChange = btcItem ? btcItem.price_change_percentage_24h_in_currency : null;
                    btc7dChange = btcItem ? btcItem.price_change_percentage_7d_in_currency : null;
                    btc30dChange = btcItem ? btcItem.price_change_percentage_30d_in_currency : null;
                    btc1yChange = btcItem ? btcItem.price_change_percentage_1y_in_currency : null;


                    const mappedData = data.map(item => {
                        const tokenInfo = TOKENS_CONFIG.find(t => t.id === item.id);
                        if (!tokenInfo) return null;

                        const rsiHeuristic = calculateRSIHeuristic(
                            item.price_change_percentage_24h_in_currency,
                            item.price_change_percentage_7d_in_currency
                        );

                        const wyckoffDynamic = generateDynamicWyckoffSignal({
                            ...item,
                            price_change_percentage_7d_in_currency: item.price_change_percentage_7d_in_currency,
                            price_change_percentage_30d_in_currency: item.price_change_percentage_30d_in_currency
                        });
                        
                        const range = estimateFutureRange(
                            item.current_price,
                            item.price_change_percentage_7d_in_currency,
                            item.price_change_percentage_30d_in_currency
                        );
                        
                        // Proximidade S/R
                        const srProximity = calculateSRProximity(item.current_price, range.weekLow, range.weekHigh);

                        const athDropPct = item.ath ? ((item.current_price - item.ath) / item.ath) * 100 : null;
                        const erScore = calculateERScore(
                            item.price_change_percentage_24h_in_currency,
                            item.price_change_percentage_7d_in_currency,
                            item.market_cap
                        );
                        const attractionScore = calculateAttractionScore(
                            athDropPct,
                            parseFloat(rsiHeuristic.text === 'N/D' ? '50' : rsiHeuristic.text),
                            wyckoffDynamic.phase,
                            erScore
                        );
                        
                        // NOVOS C√ÅLCULOS DE ALPHA VS BTC
                        const vsBtc24h = calculateVsBtcPerformance(item.price_change_percentage_24h_in_currency, btc24hChange);
                        const vsBtc7d = calculateVsBtcPerformance(item.price_change_percentage_7d_in_currency, btc7dChange);
                        const vsBtc30d = calculateVsBtcPerformance(item.price_change_percentage_30d_in_currency, btc30dChange);
                        const vsBtc1y = calculateVsBtcPerformance(item.price_change_percentage_1y_in_currency, btc1yChange);


                        const sotAnalysis = calculateSOTSignal(
                            item.price_change_percentage_1h_in_currency,
                            item.price_change_percentage_24h_in_currency,
                            item.price_change_percentage_7d_in_currency
                        );

                        const reversalAlert = calculateReversalAlert(item);
                        const staticWyckoff = STATIC_WYCKOFF_CONTEXT[tokenInfo.ticker] || 'Sem contexto est√°tico espec√≠fico definido para este ativo.';

                        return {
                            ...item,
                            ticker: tokenInfo.ticker,
                            name: tokenInfo.name,
                            rsi_heuristic: rsiHeuristic,
                            wyckoff_dynamic: wyckoffDynamic,
                            attraction_score: attractionScore,
                            sot_analysis: sotAnalysis,
                            reversal_alert: reversalAlert,
                            static_wyckoff: staticWyckoff,
                            ath_drop_pct: athDropPct,
                            sparkline_data: item.sparkline_in_7d ? item.sparkline_in_7d.price : null,
                            
                            market_cap_rank: item.market_cap_rank,
                            fully_diluted_valuation: item.fully_diluted_valuation,
                            circulating_supply: item.circulating_supply,
                            max_supply: item.max_supply,
                            
                            vs_btc_24h: vsBtc24h, // NOVO
                            vs_btc_7d: vsBtc7d,   // NOVO
                            vs_btc_30d: vsBtc30d, // NOVO
                            vs_btc_1y: vsBtc1y,   // NOVO
                            
                            sr_proximity: srProximity, 
                            range_estimates: range
                        };
                    }).filter(Boolean);

                    allCryptoData = mappedData;
                    renderAll();
                    checkAlerts(mappedData);

                    document.getElementById('last-update').textContent =
                        '√öltima atualiza√ß√£o: ' + new Date().toLocaleTimeString('pt-BR');

                    startAutoRefresh();
                    return; // Sai da fun√ß√£o ap√≥s o sucesso
                } catch (error) {
                    // Este bloco √© atingido apenas se o fetch falhar na √∫ltima tentativa
                    if (i === MAX_RETRIES - 1) {
                        console.error("Falha final na busca de dados:", error);
                        CARD_CONTAINER.innerHTML = `
                            <div class="card" style="text-align:center;">
                                <p style="margin-bottom:8px;font-weight:600;color:#dc2626;">
                                    Erro ao carregar dados do CoinGecko.
                                </p>
                                <p style="margin:0 0 10px;font-size:0.76rem;color:var(--text-muted);">
                                    Ocorreu um erro de rede ou o limite de requisi√ß√µes foi atingido. Tente novamente.
                                </p>
                                <button onclick="retryFetchData()"
                                        style="border:none;border-radius:999px;padding:6px 12px;background:#3861fb;color:#fff;font-size:0.78rem;font-weight:600;cursor:pointer;">
                                    Tentar recarregar
                                </button>
                            </div>`;
                        document.getElementById('last-update').textContent =
                            '√öltima atualiza√ß√£o: falha ao acessar a API.';
                        RANKING_CONTAINER.innerHTML =
                            '<div style="text-align:center;color:#dc2626;">N√£o foi poss√≠vel carregar o ranking.</div>';
                        HIGHLIGHT_CONTAINER.innerHTML =
                            '<div style="text-align:center;grid-column:1/span 4;color:#dc2626;">N√£o foi poss√≠vel carregar os destaques.</div>';
                    }
                }
            }
        }

        function retryFetchData() {
            showToast('Atualizando dados agora...', 2000);
            fetchMarketData();
        }

        function applyFilters(data) {
            return data.filter(item => {
                if (currentWyckoffFilter !== 'all') {
                    if (item.wyckoff_dynamic.phase !== currentWyckoffFilter) return false;
                }
                if (currentSearchTerm) {
                    const term = currentSearchTerm.toLowerCase();
                    const matchTicker = item.ticker.toLowerCase().includes(term);
                    const matchName = (item.name || '').toLowerCase().includes(term);
                    if (!matchTicker && !matchName) return false;
                }
                return true;
            });
        }

        function renderAll() {
            const filtered = applyFilters(allCryptoData);
            renderCards(filtered);
            renderRankingDashboard(allCryptoData);
            renderHighlightsDashboard(allCryptoData);
        }

        function renderCards(data) {
            if (!data || data.length === 0) {
                CARD_CONTAINER.innerHTML =
                    '<div class="card" style="text-align:center;font-size:0.8rem;">Nenhum ativo corresponde aos filtros atuais.</div>';
                return;
            }

            let html = '';
            data.forEach(item => { // Vari√°vel de itera√ß√£o 'item' (Corrigida)
                const change1h = item.price_change_percentage_1h_in_currency;
                const change24h = item.price_change_percentage_24h_in_currency;
                const change7d = item.price_change_percentage_7d_in_currency;
                const change30d = item.price_change_percentage_30d_in_currency;
                const change1y = item.price_change_percentage_1y_in_currency;
                
                const rsi = item.rsi_heuristic;
                const wyck = item.wyckoff_dynamic;
                const fib = calculateFibTargets(item.current_price);
                
                const vsBtc24h = item.vs_btc_24h; 
                const vsBtc7d = item.vs_btc_7d; 
                const vsBtc30d = item.vs_btc_30d; 
                const vsBtc1y = item.vs_btc_1y; 
                
                const srProx = item.sr_proximity; 

                let scoreClass = 'score-mid';
                if (item.attraction_score !== null) {
                    if (item.attraction_score >= 70) scoreClass = 'score-high';
                    else if (item.attraction_score <= 40) scoreClass = 'score-low';
                }

                const change24Class =
                    change24h > 0 ? 'positive' : change24h < 0 ? 'negative' : 'neutral';
                    
                const fullContext = item.static_wyckoff || '';
                // Extrai a narrativa para usar no prompt do Gemini
                const match = fullContext.match(/Narrativa:\s*\*\*(.*?)\*\*/);
                const narrative = match ? match[1].trim() : 'Geral';


                html += `
                    <div class="card" data-ticker="${item.ticker}" data-wyckoff-phase="${wyck.phase}">
                        <div class="card-header">
                            <div class="card-left">
                                <div>
                                    <div class="ticker">${item.ticker}</div>
                                    <div class="token-name">
                                        <div class="token-info-group">
                                            ${item.name}
                                            <span class="token-rank">Rank #${item.market_cap_rank || 'N/D'}</span>
                                        </div>
                                    </div>
                                </div>
                                <span class="badge">${wyck.text}</span>
                            </div>
                            <div>
                                <div class="price metric-clickable-header"
                                     data-ticker="${item.ticker}"
                                     data-label="Pre√ßo atual"
                                     data-is-value="true"> <!-- Tooltip no valor -->
                                    ${formatPrice(item.current_price)}
                                </div>
                                <div class="price-change ${change24Class} metric-clickable-header"
                                     data-ticker="${item.ticker}"
                                     data-label="Varia√ß√£o 24h"
                                     data-is-value="true"> <!-- Tooltip no valor -->
                                    24h: ${formatPercent(change24h)}
                                </div>
                            </div>
                        </div>

                        <div class="card-main-row">
                            <div class="main-metrics">
                                
                                <div class="detail-group-separator" style="grid-column: 1 / span 2; margin-top: 0;">MOMENTUM & RESILI√äNCIA</div>
                                
                                <div class="metric-row">
                                    <span class="metric-label metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="Proximidade S/R (Heur√≠stica)"
                                         data-is-value="false"> 
                                        Proximidade S/R (Heur√≠stica)
                                    </span>
                                    <span class="metric-value metric-clickable ${srProx.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="Proximidade S/R (Heur√≠stica)"
                                         data-is-value="true"> 
                                        ${srProx.text}
                                    </span>
                                </div>
                                
                                <div class="metric-row">
                                    <span class="metric-label metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (7D)"
                                         data-is-value="false"> 
                                        Alpha vs. BTC (7D)
                                    </span>
                                    <span class="metric-value metric-clickable ${vsBtc7d.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (7D)"
                                         data-is-value="true"> 
                                        ${vsBtc7d.text}
                                    </span>
                                </div>
                                
                                <div class="metric-row">
                                    <span class="metric-label metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="RSI heur√≠stico (for√ßa relativa aproximada)"
                                         data-is-value="false"> 
                                        RSI heur√≠stico
                                    </span>
                                    <span class="metric-value metric-clickable ${rsi.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="RSI heur√≠stico (for√ßa relativa aproximada)"
                                         data-is-value="true"> 
                                        ${rsi.text}
                                    </span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="Score de atra√ß√£o"
                                         data-is-value="false"> 
                                        Score de atra√ß√£o
                                    </span>
                                    <span class="metric-value metric-clickable"
                                         data-ticker="${item.ticker}"
                                         data-label="Score de atra√ß√£o"
                                         data-is-value="true"> 
                                        ${
                                            item.attraction_score === null
                                            ? 'N/D'
                                            : `<span class="score-badge ${scoreClass}">${item.attraction_score.toFixed(0)}</span>`
                                        }
                                    </span>
                                </div>
                            </div>
                            <div class="sparkline-wrapper">
                                <canvas class="sparkline" id="sparkline-${item.ticker}"></canvas>
                            </div>
                        </div>

                        <div class="card-toggle">Toque para abrir detalhes Wyckoff/Fibonacci e ferramentas de trade</div>

                        <div class="card-details">
                            <div class="detail-grid">
                                
                                <div class="detail-group-separator">FUNDAMENTOS & TOKEN√îMICA</div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Fully Diluted Valuation (FDV) (Risco de Dilui√ß√£o)"
                                         data-is-value="false">
                                        FDV (Risco de Dilui√ß√£o)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Fully Diluted Valuation (FDV) (Risco de Dilui√ß√£o)"
                                         data-type="number"
                                         data-value="${item.fully_diluted_valuation ?? ''}"
                                         data-is-value="true">
                                        ${formatDollarValue(item.fully_diluted_valuation)}
                                    </div>
                                    <div class="detail-hint">Valor do ativo na oferta total de tokens.</div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Tokens em Circula√ß√£o (Oferta Atual)"
                                         data-is-value="false">
                                        Tokens em Circula√ß√£o (Oferta Atual)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Tokens em Circula√ß√£o (Oferta Atual)"
                                         data-type="number"
                                         data-value="${item.circulating_supply ?? ''}"
                                         data-is-value="true">
                                        ${formatTokenCount(item.circulating_supply)}
                                    </div>
                                    <div class="detail-hint">Total de tokens no mercado.</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Capitaliza√ß√£o de mercado (liquidez estrutural)"
                                         data-is-value="false">
                                        Market Cap
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Capitaliza√ß√£o de mercado (liquidez estrutural)"
                                         data-type="text"
                                         data-value=""
                                         data-is-value="true">
                                        ${formatDollarValue(item.market_cap)}
                                    </div>
                                    <div class="detail-hint">Tamanho do projeto.</div>
                                </div>

                                
                                <div class="detail-group-separator">AN√ÅLISE DE TEND√äNCIA E CICLO</div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Varia√ß√£o 1h"
                                         data-is-value="false">
                                        Varia√ß√£o 1h
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Varia√ß√£o 1h"
                                         data-type="number"
                                         data-value="${change1h ?? ''}"
                                         data-is-value="true">
                                        ${formatPercent(change1h)}
                                    </div>
                                    <div class="detail-hint">Volatilidade Imediata.</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Varia√ß√£o 7D"
                                         data-is-value="false">
                                        Varia√ß√£o 7D
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Varia√ß√£o 7D"
                                         data-type="number"
                                         data-value="${change7d ?? ''}"
                                         data-is-value="true">
                                        ${formatPercent(change7d)}
                                    </div>
                                    <div class="detail-hint">Dire√ß√£o Semanal.</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Varia√ß√£o 30D"
                                         data-is-value="false">
                                        Varia√ß√£o 30D
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Varia√ß√£o 30D"
                                         data-type="number"
                                         data-value="${change30d ?? ''}"
                                         data-is-value="true">
                                        ${formatPercent(change30d)}
                                    </div>
                                    <div class="detail-hint">Dire√ß√£o Mensal.</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Varia√ß√£o 1 Ano"
                                         data-is-value="false">
                                        Varia√ß√£o 1 Ano
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Varia√ß√£o 1 Ano"
                                         data-type="number"
                                         data-value="${change1y ?? ''}"
                                         data-is-value="true">
                                        ${formatPercent(change1y)}
                                    </div>
                                    <div class="detail-hint">Fase do Ciclo Macro.</div>
                                </div>
                                
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Desconto atual em rela√ß√£o ao topo hist√≥rico (ATH)"
                                         data-is-value="false">
                                        Desconto vs. ATH
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Desconto atual em rela√ß√£o ao topo hist√≥rico (ATH)"
                                         data-type="number"
                                         data-value="${item.ath_drop_pct ?? ''}"
                                         data-is-value="true">
                                        ${item.ath_drop_pct === null ? 'N/D' : item.ath_drop_pct.toFixed(2) + '%'}
                                    </div>
                                    <div class="detail-hint">Margem de Seguran√ßa.</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Sinal Wyckoff (din√¢mico)"
                                         data-is-value="false">
                                        Sinal Wyckoff (din√¢mico)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Sinal Wyckoff (din√¢mico)"
                                         data-type="text"
                                         data-value="${wyck.text}"
                                         data-is-value="true">
                                        ${wyck.text}
                                    </div>
                                    <div class="detail-hint">Leitura do est√°gio atual do ciclo.</div>
                                </div>
                                
                                <div class="detail-group-separator">ALPHA (FOR√áA RELATIVA VS. BTC)</div>
                                
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (24H)"
                                         data-is-value="false">
                                        Alpha vs. BTC (24H)
                                    </div>
                                    <span class="detail-value ${vsBtc24h.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (24H)"
                                         data-value="${vsBtc24h.value}"
                                         data-is-value="true">
                                        ${vsBtc24h.text}
                                    </span>
                                    <div class="detail-hint">Performance do dia.</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (7D)"
                                         data-is-value="false">
                                        Alpha vs. BTC (7D)
                                    </div>
                                    <span class="detail-value ${vsBtc7d.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (7D)"
                                         data-value="${vsBtc7d.value}"
                                         data-is-value="true">
                                        ${vsBtc7d.text}
                                    </span>
                                    <div class="detail-hint">Performance da semana.</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (30D)"
                                         data-is-value="false">
                                        Alpha vs. BTC (30D)
                                    </div>
                                    <span class="detail-value ${vsBtc30d.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (30D)"
                                         data-value="${vsBtc30d.value}"
                                         data-is-value="true">
                                        ${vsBtc30d.text}
                                    </span>
                                    <div class="detail-hint">Performance do m√™s.</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (1 Ano)"
                                         data-is-value="false">
                                        Alpha vs. BTC (1 Ano)
                                    </div>
                                    <span class="detail-value ${vsBtc1y.class}"
                                         data-ticker="${item.ticker}"
                                         data-label="Alpha vs. BTC (1 Ano)"
                                         data-value="${vsBtc1y.value}"
                                         data-is-value="true">
                                        ${vsBtc1y.text}
                                    </span>
                                    <div class="detail-hint">Performance de ciclo.</div>
                                </div>


                                
                                <div class="detail-group-separator">ZONAS DE REFER√äNCIA & REVERS√ÉO</div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Pre√ßo-alvo de compra (Fibonacci)"
                                         data-is-value="false">
                                        Pre√ßo-alvo de compra (Fib)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Pre√ßo-alvo de compra (Fibonacci)"
                                         data-type="number"
                                         data-value="${fib.buy ?? ''}"
                                         data-is-value="true">
                                        ${formatPrice(fib.buy)}
                                    </div>
                                    <div class="detail-hint">Zona de desconto sugerida.</div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Pre√ßo-alvo de realiza√ß√£o (Fibonacci)"
                                         data-is-value="false">
                                        Pre√ßo-alvo de realiza√ß√£o (Fib)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Pre√ßo-alvo de realiza√ß√£o (Fibonacci)"
                                         data-type="number"
                                         data-value="${fib.sell ?? ''}"
                                         data-is-value="true">
                                        ${formatPrice(fib.sell)}
                                    </div>
                                    <div class="detail-hint">Faixa de refer√™ncia para lucros.</div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Stop t√©cnico de prote√ß√£o (Fibonacci)"
                                         data-is-value="false">
                                        Stop t√©cnico (Fib)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Stop t√©cnico de prote√ß√£o (Fibonacci)"
                                         data-type="number"
                                         data-value="${fib.stopLoss ?? ''}"
                                         data-is-value="true">
                                        ${formatPrice(fib.stopLoss)}
                                    </div>
                                    <div class="detail-hint">N√≠vel de invalida√ß√£o.</div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Alvo de causa x efeito (Wyckoff + Fib)"
                                         data-is-value="false">
                                        Alvo Causa x Efeito
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Alvo de causa x efeito (Wyckoff + Fib)"
                                         data-type="number"
                                         data-value="${fib.causaEfeitoTP ?? ''}"
                                         data-is-value="true">
                                        ${formatPrice(fib.causaEfeitoTP)}
                                    </div>
                                    <div class="detail-hint">Proje√ß√£o te√≥rica Mark-up.</div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Alerta de revers√£o em 30 dias"
                                         data-is-value="false">
                                        Alerta de revers√£o (30D)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Alerta de revers√£o em 30 dias"
                                         data-type="text"
                                         data-value=""
                                         data-is-value="true">
                                        ${item.reversal_alert.text}
                                    </div>
                                    <div class="detail-hint">Previs√£o de invers√£o de m√©dio prazo.</div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Leitura SOT / falha estrutural"
                                         data-is-value="false">
                                        Leitura SOT
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Leitura SOT / falha estrutural"
                                         data-type="text"
                                         data-value=""
                                         data-is-value="true">
                                        ${item.sot_analysis.text}
                                    </div>
                                    <div class="detail-hint">Falha na continuidade da tend√™ncia.</div>
                                </div>
                                
                                <div class="detail-group-separator">PROJE√á√ïES DE RANGE</div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Faixa projetada para a pr√≥xima semana"
                                         data-is-value="false">
                                        Faixa projetada (1W)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Faixa projetada para a pr√≥xima semana"
                                         data-type="range"
                                         data-value=""
                                         data-is-value="true">
                                        ${formatPrice(item.range_estimates.weekLow)} ‚Äì ${formatPrice(item.range_estimates.weekHigh)}
                                    </div>
                                    <div class="detail-hint">Intervalo de oscila√ß√£o para 7 dias.</div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Faixa projetada para 2 semanas"
                                         data-is-value="false">
                                        Faixa projetada (2W)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Faixa projetada para 2 semanas"
                                         data-type="range"
                                         data-value=""
                                         data-is-value="true">
                                        ${formatPrice(item.range_estimates.twoWeeksLow)} ‚Äì ${formatPrice(item.range_estimates.twoWeeksHigh)}
                                    </div>
                                    <div class="detail-hint">Vis√£o de 14 dias (Swing Trade).</div>
                                </div>

                                <div class="detail-item">
                                    <div class="detail-label"
                                         data-ticker="${item.ticker}"
                                         data-label="Faixa projetada para o pr√≥ximo m√™s"
                                         data-is-value="false">
                                        Faixa projetada (1M)
                                    </div>
                                    <div class="detail-value"
                                         data-ticker="${item.ticker}"
                                         data-label="Faixa projetada para o pr√≥ximo m√™s"
                                         data-type="range"
                                         data-value=""
                                         data-is-value="true">
                                        ${formatPrice(item.range_estimates.monthLow)} ‚Äì ${formatPrice(item.range_estimates.monthHigh)}
                                    </div>
                                    <div class="detail-hint">Amplitude prov√°vel em 30 dias.</div>
                                </div>
                            </div>

                            <div class="wyckoff-tag">
                                <strong>Contexto Wyckoff est√°tico:</strong> ${item.static_wyckoff}
                            </div>
                            
                            <!-- NOVO: AN√ÅLISE DE SENTIMENTO GEMINI -->
                            <div class="gemini-analysis-section">
                                <h4>‚ú® An√°lise Fundamentalista de Mercado (Gemini)</h4>
                                <button id="gemini-btn-${item.ticker}" 
                                        onclick="fetchSentimentAnalysis('${item.ticker}', '${narrative.replace(/'/g, "\\'")}')" 
                                        style="padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.78rem;">
                                    Gerar An√°lise de Sentimento Agora
                                </button>
                                <div id="gemini-loader-${item.ticker}" class="loading-indicator">
                                    Buscando dados em tempo real... (Pode levar at√© 10s)
                                </div>
                                <div id="gemini-result-${item.ticker}" style="margin-top: 10px;">
                                    <p style="margin:0; font-size: 0.7rem; color: var(--text-muted);">A an√°lise usar√° o Google Search para garantir dados atualizados.</p>
                                </div>
                            </div>
                            
                            <!-- SE√á√ÉO DE TRADE E ALERTA ORIGINAL -->
                            <div class="alert-trade-section">
                                <h4>Simula√ß√£o de Trade e Alerta Local</h4>
                                <div class="trade-buttons">
                                    <button class="btn-buy" onclick="registerTrade('${item.ticker}', 'buy', ${item.current_price}, ${item.current_price})">
                                        COMPRAR AGORA (${formatPrice(item.current_price)})
                                    </button>
                                    <button class="btn-sell" onclick="registerTrade('${item.ticker}', 'sell', ${item.current_price}, ${item.current_price})">
                                        VENDER/FECHAR (${formatPrice(item.current_price)})
                                    </button>
                                </div>

                                <form class="trade-form" onsubmit="event.preventDefault(); addAlert('${item.ticker}', document.getElementById('alert-type-${item.ticker}').value, document.getElementById('alert-price-${item.ticker}').value); return false;">
                                    <select id="alert-type-${item.ticker}" required>
                                        <option value="buy">Alvo de COMPRA (entrada)</option>
                                        <option value="sell">Alvo de VENDA (sa√≠da)</option>
                                    </select>
                                    <input type="number" id="alert-price-${item.ticker}" placeholder="Pre√ßo alvo em USD (ex: ${fib.buy ? fib.buy.toFixed(2) : '0.00'})" step="any" required>
                                    <button type="submit">Salvar alerta de pre√ßo</button>
                                </form>

                                <div class="active-alerts-list"></div>
                                <div class="trade-history-list"></div>
                            </div>
                            <div class="tradingview-container" id="tv-${item.ticker}"></div>
                        </div>
                    </div>
                `;
            });

            CARD_CONTAINER.innerHTML = html;

            document.querySelectorAll('.card').forEach(card => {
                const toggle = card.querySelector('.card-toggle');
                const ticker = card.getAttribute('data-ticker');
                toggle.addEventListener('click', () => {
                    const expanded = card.classList.toggle('expanded');
                    if (expanded) {
                        initTradingViewWidget(ticker);
                        renderCardAlerts(ticker); // Renderiza alertas ao expandir
                        renderCardTrades(ticker); // Renderiza hist√≥rico de trades ao expandir
                    }
                });
            });

            // ATUALIZA√á√ÉO DOS LISTENERS: Agora escuta classes de labels e valores
            document.querySelectorAll('.metric-label, .metric-value, .metric-clickable-header, .detail-label, .detail-value').forEach(el => {
                el.addEventListener('click', () => {
                    const ticker = el.getAttribute('data-ticker');
                    const label = el.getAttribute('data-label');
                    const isValue = el.getAttribute('data-is-value') === 'true'; // Novo flag
                    
                    const item = allCryptoData.find(c => c.ticker === ticker);
                    if (!item) return;

                    let value;
                    let rawValue = el.getAttribute('data-value');
                    let type = el.getAttribute('data-type');
                    
                    // L√≥gica para obter o valor correto com base no label/tipo
                    if (label.startsWith('Alpha vs. BTC')) {
                         const period = label.match(/\((.*?)\)/)[1].replace(/H|D|Ano/g, '').toLowerCase(); // Pega '24', '7', '30', '1'
                         value = item[`vs_btc_${period.replace(' ', '')}`]?.value; 
                    } else if (label.startsWith('Varia√ß√£o')) {
                         const period = label.match(/(\d+H|\d+D|Ano)/)[1];
                         if (period === '1h') value = item.price_change_percentage_1h_in_currency;
                         else if (period === '24h') value = item.price_change_percentage_24h_in_currency;
                         else if (period === '7D') value = item.price_change_percentage_7d_in_currency;
                         else if (period === '30D') value = item.price_change_percentage_30d_in_currency;
                         else if (period === '1 Ano') value = item.price_change_percentage_1y_in_currency;
                    } else if (type === 'range') {
                        value = item.range_estimates;
                    } else if (label === 'Proximidade S/R (Heur√≠stica)' && isValue) {
                        value = item.sr_proximity.value; 
                    } else if (label === 'Desconto atual em rela√ß√£o ao topo hist√≥rico (ATH)' && isValue) {
                         value = item.ath_drop_pct;
                    } else if (label === 'RSI heur√≠stico (for√ßa relativa aproximada)' && isValue) {
                        value = item.rsi_heuristic.value;
                    } else if (label === 'Fully Diluted Valuation (FDV) (Risco de Dilui√ß√£o)' && isValue) {
                         value = item.fully_diluted_valuation;
                    } else if (label === 'Tokens em Circula√ß√£o (Oferta Atual)' && isValue) {
                        value = item.circulating_supply;
                    } else if (type === 'number' && isValue) {
                         // Trata valores diretos como Fib/Score (usando rawValue, mas garantindo que √© um n√∫mero)
                         value = parseFloat(rawValue); 
                    } else {
                         // Default para evitar bugs, usando o rawValue original
                         value = rawValue;
                    }


                    const text = getAnalyticalInterpretation(label, value, item, isValue);
                    
                    let title = isValue ? `${ticker} ‚Ä¢ An√°lise: ${label}` : `${ticker} ‚Ä¢ Conceito: ${label}`;
                    openMetricTooltip(title, text);
                });
            });

            data.forEach(item => {
                const canvas = document.getElementById('sparkline-' + item.ticker);
                if (canvas && item.sparkline_data) {
                    drawSparkline(canvas, item.sparkline_data);
                }
            });
        }

        function initTradingViewWidget(ticker) {
            const containerId = 'tv-' + ticker;
            const container = document.getElementById(containerId);
            if (!container || container.getAttribute('data-loaded') === '1') return;

            const symbol = getTradingViewSymbol(ticker);
            container.setAttribute('data-loaded', '1');

            new TradingView.widget({
                autosize: true,
                symbol: symbol,
                interval: '60',
                timezone: 'Etc/UTC',
                theme: 'light',
                style: '1',
                locale: 'br',
                toolbar_bg: '#f1f3f6',
                enable_publishing: false,
                hide_top_toolbar: true,
                hide_legend: true,
                save_image: false,
                container_id: containerId
            });
        }

        // --- RENDER PARA DESTAQUES ---
        function renderHighlightsDashboard(data) {
            if (!data || data.length === 0) {
                HIGHLIGHT_CONTAINER.innerHTML =
                    '<div style="text-align:center;grid-column:1/span 4;">Sem dados para destaques.</div>';
                return;
            }

            // 1. TOP 10 Valorizadas (24h)
            const topValued = [...data].sort((a, b) => (b.price_change_percentage_24h_in_currency || -Infinity) - (a.price_change_percentage_24h_in_currency || -Infinity)).slice(0, 10);
            // 2. TOP 10 Desvalorizadas (24h)
            const topDevalued = [...data].sort((a, b) => (a.price_change_percentage_24h_in_currency || Infinity) - (b.price_change_percentage_24h_in_currency || Infinity)).slice(0, 10);
            // 3. TOP 10 Ativos mais fortes (Maior Score de Atra√ß√£o)
            const topStrong = [...data].sort((a, b) => (b.attraction_score || -Infinity) - (a.attraction_score || -Infinity)).slice(0, 10);
            // 4. TOP 10 Ativos mais fracos (Menor RSI Heur√≠stico - sugere sobre-venda extrema)
            const topWeak = [...data].sort((a, b) => (a.rsi_heuristic.value || Infinity) - (b.rsi_heuristic.value || Infinity)).slice(0, 10);

            let html = `
                <div class="highlight-card">
                    <h4>Top Valorizadas (24h) üöÄ</h4>
                    ${topValued.map(i => `
                        <div class="highlight-item"
                            data-ticker="${i.ticker}"
                            data-label="Top Valorizadas (24h)"
                            onclick="openTooltipFromHighlight('${i.ticker}', 'Top Valorizadas (24h)')">
                            <span>${i.ticker}</span>
                            <span class="positive">${formatPercent(i.price_change_percentage_24h_in_currency)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="highlight-card">
                    <h4>Top Desvalorizadas (24h) üîª</h4>
                    ${topDevalued.map(i => `
                        <div class="highlight-item"
                            data-ticker="${i.ticker}"
                            data-label="Top Desvalorizadas (24h)"
                            onclick="openTooltipFromHighlight('${i.ticker}', 'Top Desvalorizadas (24h)')">
                            <span>${i.ticker}</span>
                            <span class="negative">${formatPercent(i.price_change_percentage_24h_in_currency)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="highlight-card">
                    <h4>Top Atra√ß√£o (Forte Compra) ‚≠ê</h4>
                    ${topStrong.map(i => `
                        <div class="highlight-item"
                            data-ticker="${i.ticker}"
                            data-label="Top Atra√ß√£o (Forte Compra)"
                            onclick="openTooltipFromHighlight('${i.ticker}', 'Top Atra√ß√£o (Forte Compra)')">
                            <span>${i.ticker}</span>
                            <span class="score-badge ${i.attraction_score >= 70 ? 'score-high' : 'score-mid'}">${i.attraction_score === null ? 'N/D' : i.attraction_score.toFixed(0)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="highlight-card">
                    <h4>Top Sobre-venda (Fraco) üìâ</h4>
                    ${topWeak.map(i => `
                        <div class="highlight-item"
                            data-ticker="${i.ticker}"
                            data-label="Top Sobre-venda (Fraco)"
                            onclick="openTooltipFromHighlight('${i.ticker}', 'Top Sobre-venda (Fraco)')">
                            <span>${i.ticker}</span>
                            <span class="rsi-low">${i.rsi_heuristic.text}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            HIGHLIGHT_CONTAINER.innerHTML = html;

            // Re-adiciona listener para expandir o card ao clicar no item
            document.querySelectorAll('.highlight-item').forEach(el => {
                el.addEventListener('click', (e) => {
                    const ticker = el.getAttribute('data-ticker');
                    // Verifica se o clique foi na tooltip. Se n√£o foi, expande o card.
                    if (e.target.tagName !== 'SPAN' || !e.target.closest('.metric-tooltip-overlay')) {
                        const card = document.querySelector(`.card[data-ticker="${ticker}"]`);
                        if (!card) return;
                        card.classList.add('expanded');
                        initTradingViewWidget(ticker);
                        renderCardAlerts(ticker); // Renderiza alertas ao expandir
                        renderCardTrades(ticker); // Renderiza hist√≥rico de trades ao expandir
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            });
        }

        // Nova fun√ß√£o para abrir tooltip a partir dos destaques
        window.openTooltipFromHighlight = function(ticker, label) {
            const item = allCryptoData.find(c => c.ticker === ticker);
            if (!item) return;
            
            let value;
            // CORRE√á√ÉO: Pega o valor correto para an√°lise com base no label
            if (label === 'Top Valorizadas (24h)' || label === 'Top Desvalorizadas (24h)') {
                value = item.price_change_percentage_24h_in_currency;
            } else if (label === 'Top Atra√ß√£o (Forte Compra)') {
                value = item.attraction_score;
            } else if (label === 'Top Sobre-venda (Fraco)') {
                value = item.rsi_heuristic.value;
            }
            
            // Agora passa o valor espec√≠fico para a fun√ß√£o de interpreta√ß√£o
            const text = getAnalyticalInterpretation(label, value, item, true);
            openMetricTooltip(`${ticker} ‚Ä¢ An√°lise: ${label}`, text);
        }

        function renderRankingDashboard(data) {
            if (!data || data.length === 0) {
                RANKING_CONTAINER.innerHTML =
                    '<div style="text-align:center;">Sem dados para ranking.</div>';
            return;
            }

            let filtered = [...data];
            if (currentDashboardFilter === 'compra') {
                filtered = filtered.filter(i => i.wyckoff_dynamic.phase === 'acc');
                filtered.sort((a, b) => (b.attraction_score || 0) - (a.attraction_score || 0));
            } else if (currentDashboardFilter === 'venda') {
                filtered = filtered.filter(i => i.wyckoff_dynamic.phase === 'dist');
                filtered.sort((a, b) => (b.price_change_percentage_30d_in_currency || 0) -
                                        (a.price_change_percentage_30d_in_currency || 0));
            } else {
                filtered.sort((a, b) => (b.attraction_score || 0) - (a.attraction_score || 0));
            }

            const top = filtered.slice(0, 8);

            let html = `
                <div class="ranking-columns">
                    <div class="ranking-card">
                        <h4>Top assimetria (score)</h4>
                        ${top.map(i => `
                            <div class="ranking-item" data-ticker="${i.ticker}">
                                <span>${i.ticker}</span>
                                <span>${i.attraction_score === null ? 'N/D' : i.attraction_score.toFixed(0)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="ranking-card">
                        <h4>Movimento em 30 dias</h4>
                        ${top.map(i => `
                            <div class="ranking-item" data-ticker="${i.ticker}">
                                <span>${i.ticker}</span>
                                <span>${formatPercent(i.price_change_percentage_30d_in_currency)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            RANKING_CONTAINER.innerHTML = html;

            document.querySelectorAll('.ranking-item').forEach(el => {
                el.addEventListener('click', () => {
                    const ticker = el.getAttribute('data-ticker');
                    const card = document.querySelector(`.card[data-ticker="${ticker}"]`);
                    if (!card) return;
                    card.classList.add('expanded');
                    initTradingViewWidget(ticker);
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });
        }

        function startAutoRefresh() {
            if (refreshTimer) clearTimeout(refreshTimer);
            if (countdownTimer) clearInterval(countdownTimer);

            countdownSeconds = REFRESH_INTERVAL_MS / 1000;
            document.getElementById('countdown').textContent = countdownSeconds + 's';

            countdownTimer = setInterval(() => {
                countdownSeconds--;
                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    fetchMarketData();
                } else {
                    document.getElementById('countdown').textContent = countdownSeconds + 's';
                }
            }, 1000);
        }

        // NOVO: Fun√ß√µes de Rolagem
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function scrollToBottom() {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }


        function setupEventListeners() {
            document.getElementById('refresh-button').addEventListener('click', () => {
                showToast('Atualizando dados agora...', 2000);
                fetchMarketData();
            });
            
            // NOVO: Listeners para as setas de rolagem
            document.getElementById('scroll-to-top').addEventListener('click', scrollToTop);
            document.getElementById('scroll-to-bottom').addEventListener('click', scrollToBottom);


            document.getElementById('search-input').addEventListener('input', e => {
                currentSearchTerm = e.target.value.trim();
                renderAll();
            });

            document.querySelectorAll('input[name="wyckoff-filter"]').forEach(r => {
                r.addEventListener('change', e => {
                    currentWyckoffFilter = e.target.value;
                    document.querySelectorAll('#wyckoff-filter-group label').forEach(lbl => {
                        lbl.classList.remove('active');
                    });
                    e.target.parentElement.classList.add('active');
                    renderAll();
                });
            });

            // ATUALIZA√á√ÉO: Escutador de eventos para os filtros movidos
            document.querySelectorAll('input[name="dashboard-filter"]').forEach(r => {
                r.addEventListener('change', e => {
                    currentDashboardFilter = e.target.value;
                    document.querySelectorAll('#dashboard-filter-group label').forEach(lbl => {
                        lbl.classList.remove('active');
                    });
                    e.target.parentElement.classList.add('active');
                    renderRankingDashboard(allCryptoData);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromStorage(); // Carrega alertas E trades
            setupEventListeners();
            fetchMarketData();
        });
    </script>
</body>
</html>
